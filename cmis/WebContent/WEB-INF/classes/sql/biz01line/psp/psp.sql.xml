<?xml version="1.0" encoding="UTF-8"?>
<S>
<!-- 查询担保品重估 -->
<SQL id="queryPspGuarantyReeval" parameterClass="java.util.HashMap" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
  	select a.pk_id,
       a.task_id,
       a.cus_id,
       a.batch_reeval_value,
       a.reeval_value,
       a.input_id,
       a.input_br_id,
       a.input_date,
       b.guaranty_no,
       b.guaranty_name,
       (select reeval_value
          from (select reeval_value
                  from psp_guaranty_value_reeval
                 where guaranty_no = ${guaranty_no}
                       and task_id != ${task_id}
                 order by input_date desc)
         where rownum = 1) last_reeval_value
  from (select *
          from psp_guaranty_value_reeval
         where task_id = ${task_id}
           and guaranty_no = ${guaranty_no}) a,
       mort_guaranty_base_info b
 where b.guaranty_no = ${guaranty_no}
   and a.guaranty_no(+) = b.guaranty_no
  ]]>
  </SELECT>
</SQL>
<!-- 获取客户当前的循环额度 -->
<SQL id="queryLmtCirCrdAmtByCusId" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
  	select nvl(sum(a.crd_amt),0) cir_crd_amt from lmt_agr_details a where a.cus_id = ${_SIG_VALUE} and a.lmt_status = '10' and a.limit_type = '01'
  ]]>
  </SELECT>
</SQL>
<!-- 获取客户当前的一次性额度 -->
<SQL id="queryLmtOnceCrdAmtByCusId" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
  	select nvl(sum(a.crd_amt),0) once_crd_amt from lmt_agr_details a where a.cus_id = ${_SIG_VALUE} and a.lmt_status = '10' and a.limit_type = '02'
  ]]>
  </SELECT>
</SQL>
<!-- 获取客户当前的贷款信息 -->
<SQL id="queryAccInfoByCusId" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
  	select nvl(sum(a.loan_amt), 0) loan_amt,
       nvl(sum(a.loan_balance), 0) loan_balance,
       nvl(sum(a.inner_owe_int), 0) + nvl(sum(a.out_owe_int), 0) owe_int
  	 from acc_loan a
 	 where a.cus_id = ${_SIG_VALUE}
   	 and a.acc_status = '1'
  ]]>
  </SELECT>
</SQL>
<!-- 获取集团成员信息 -->
<SQL id="queryGrpListForPsp" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
  	select a.task_id,a.cus_id,a.grp_no, b.grp_name, c.grp_corre_type,a.approve_status
  	 from psp_check_task a, cus_grp_info b, cus_grp_member c
 	 where a.grp_task_id = ${_SIG_VALUE}
   	 and a.grp_no = b.grp_no
   	 and c.cus_id = a.cus_id
  ]]>
  </SELECT>
</SQL>
<!-- 获取集团成员的检查类型，检查频率等信息 modified by yangzy 2015/09/24 贷后集团任务检查过滤已完成的成员任务 -->
<SQL id="queryGrpAllListForPsp" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
  	select a.task_id,a.cus_id,a.grp_no,a.check_type,a.task_type,a.psp_cus_type,a.check_freq
  	 from psp_check_task a, cus_grp_info b, cus_grp_member c
 	 where a.grp_task_id = ${_SIG_VALUE}
   	 and a.grp_no = b.grp_no
   	 and c.cus_id = a.cus_id
   	 and a.approve_status not in ('997','998')
  ]]>
  </SELECT>
</SQL>
<!-- 获取客户当前的资金监控合计数 -->
<SQL id="queryCapInfoByCusId" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
  	select nvl(sum(a.disb_amt),0) disb_amt from psp_cap_use_monitor a where a.cus_id = ${_SIG_VALUE}
  ]]>
  </SELECT>
</SQL>

<!-- 根据行业分类获得此行业存在有效业务的所有客户 -->
<SQL id="queryCusIdByComCllType" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
  	select cus_id from cus_com where cus_id in (select cus_id from acc_view where status not in('0','8','9')) and COM_CLL_TYPE=${_SIG_VALUE}
  ]]>
  </SELECT>
</SQL>
<!-- 根据主管客户经理获得此主管客户经理辖内存在有效业务的所有客户 -->
<SQL id="queryCusIdByCustMgr" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
  	select cus_id from cus_base where cus_id in (select cus_id from acc_view where status not in('0','8','9')) and CUST_MGR=${_SIG_VALUE}
  ]]>
  </SELECT>
</SQL>
<!-- 根据客户主管机构获得此机构下存在有效业务的所有客户 -->
<SQL id="queryCusIdByMainBrId" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
  	select cus_id,MAIN_BR_ID from cus_base where cus_id in (select cus_id from acc_view where status not in('0','8','9')) and MAIN_BR_ID=${_SIG_VALUE}
  ]]>
  </SELECT>
</SQL>

<!-- 根据金额区间过滤存在有效业务的所有客户 -->
<SQL id="queryCusIdByLoanAmt" parameterClass="com.ecc.emp.data.KeyedCollection" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
  	select cus_id from acc_view where status not in('0','8','9') and bill_bal >= ${loan_amt_begin} and bill_bal < ${loan_amt_end} group by cus_id
  ]]>
  </SELECT>
</SQL>

<!-- 根据客户码判断此客户是否存在有效业务信息 -->
<SQL id="checkTrueByCusId" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
  	select count(*) as counts from psp_acc_view where cus_id=${_SIG_VALUE}
  ]]>
  </SELECT>
</SQL>

<!-- 根据申请流水号，删除解除预警关联表【psp_ravel_signal_list】中对应的数据  -->
<SQL id="deletePspRavelSignalList" parameterClass="java.lang.String" >
   <DELETE>
  <![CDATA[
  	DELETE FROM PSP_RAVEL_SIGNAL_LIST WHERE SERNO = ${_SIG_VALUE}
  ]]>
   </DELETE>
</SQL>
<!-- 根据客户码判断此客户是否存在未完成的贷后任务 added by yangzy 2014/10/28 客户移交风险校验贷后任务 -->
<SQL id="checkPspCheckTaskByCusId" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
  	select count(*) as counts from psp_check_task where cus_id=${_SIG_VALUE} and approve_status in ('000','111','991','992','993')
  ]]>
  </SELECT>
</SQL>
<!-- add by lisj 2015-5-21 需求编号：XD150504034 贷后管理常规检查任务改造 -->
<SQL id="queryGrpInfoByTaskId" parameterClass="java.lang.String" resultClass="java.lang.String" onlyReturnFirst="false">
  <SELECT>
  <![CDATA[
  	  SELECT CASE
           WHEN (SUBSTR(P1.TASK_CREATE_DATE, 6, 10)) <> '01-01' THEN
            'PASS'
           WHEN (SUBSTR(P1.TASK_CREATE_DATE, 6, 10)) = '01-01' AND
                TRIM(GRP_MEMBER_INFOS) IS NOT NULL THEN
            'PASS'
           ELSE
            'FORBID'
         END AS FLAG
    FROM PSP_CHECK_ANALY P, PSP_CHECK_TASK P1
   WHERE P1.TASK_ID = P.TASK_ID(+)
     AND P1.TASK_ID = ${_SIG_VALUE}
  ]]>
  </SELECT>
</SQL>
</S>