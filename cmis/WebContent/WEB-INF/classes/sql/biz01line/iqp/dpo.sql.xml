<?xml version="1.0" encoding="UTF-8"?>
<S>
<!-- 根据汇票号码获得相关汇票信息（票据池时使用）-->
<SQL id="getPorderMsgByPorderNoDrfpo" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
	SELECT * FROM iqp_bill_detail_info WHERE PORDER_NO = ${_SIG_VALUE}
  ]]>
  </SELECT>
</SQL>

<!-- 根据池编号获得所属池下的票据信息-->
<SQL id="getBillInfoByDrfpoNo" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
	select b.status,a.bill_type,a.porder_no,a.is_ebill,a.bill_isse_date,a.porder_end_date,a.porder_curr,a.drft_amt from iqp_bill_detail_info a, iqp_corre_info b where b.drfpo_no = ${_SIG_VALUE} and a.porder_no = b.porder_no
  ]]>
  </SELECT>
</SQL>

<!-- 根据汇票号码获得获得票据的主管经理和主管机构-->
<SQL id="getManagementInfoByPorderNo" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
	select b.drfpo_no,b.manager_id,b.manager_br_id from iqp_drfpo_mana b where b.drfpo_no in (select a.drfpo_no from iqp_corre_info a where a.porder_no = ${_SIG_VALUE})
  ]]>
  </SELECT>
</SQL>
<!-- 删除票据池信息时，级联删除池内票据与票据池关联信息-->
<SQL id="deleteDrfpoRelationByDrfpoNo" parameterClass="java.lang.String">
  <SELECT>
  <![CDATA[
	DELETE FROM iqp_corre_info WHERE DRFPO_NO = ${_SIG_VALUE}
  ]]>
  </SELECT>
</SQL>

<!-- 删除票据池记录-->
<SQL id="deleteDrfpoByDrfpoNo" parameterClass="java.lang.String">
  <SELECT>
  <![CDATA[
	DELETE FROM IQP_DRFPO_MANA WHERE DRFPO_NO = ${_SIG_VALUE}
  ]]>
  </SELECT>
</SQL>

<!-- 根据票据池编号获得相关汇票信息-->
<SQL id="getPorderListByDrfpoNo"  parameterClass="java.util.HashMap" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
	select a.porder_no,a.bill_type,a.is_ebill,a.bill_isse_date,a.porder_end_date,a.drft_amt from iqp_bill_detail_info a where a.porder_no in (select b.porder_no from iqp_corre_info b where b.status in(${status}) and b.drfpo_no=${drfpo_no})
  ]]>
  </SELECT>
</SQL>

<!-- 根据汇票池编号和票据的池状态查询所有池中票据的票面金额-->
<SQL id="getDrftAmtByDrfpoNo"  parameterClass="java.util.HashMap" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
	select a.drft_amt from iqp_bill_detail_info a where a.porder_no in (select b.porder_no from iqp_corre_info b where b.status=${status} and b.drfpo_no=${drfpo_no})
  ]]>
  </SELECT>
</SQL>

<!--- 应收账款明细回款登记  需求编号：XD140827055   开始   2014-10-17 唐顺岩   -->
<!-- 根据发票号与贸易合同编号查询关联的应收账款下关联的保证金交易明细 -->
<SQL id="queryRIqpActrecRepayList"  parameterClass="java.util.HashMap" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
	SELECT R.TRAN_SERNO,R.PO_NO,R.CONT_NO,ORGANNO,BAIL_ACCT_NO,BAIL_AMT,GYLSH,D.INPUT_DATE FROM R_IQP_ACTREC_REPAY R,IQP_CORE_BAIL_DETAIL D WHERE R.TRAN_SERNO=D.SERNO AND INVC_NO=${invc_no} AND CONT_NO=${cont_no}
  ]]>
  </SELECT>
</SQL>

<!--modified by lisj 2015-2-2 需求编号【HS141110017】保理业务改造 begin -->
<!-- 根据保证金账户查询保证金账户交易流水，用于关联应收账款的回款保证金,剔除已经关联的  -->
<SQL id="queryIqpCoreBailDetailList" parameterClass="java.util.HashMap" resultClass="com.ecc.emp.data.KeyedCollection">
    <SELECT>
  <![CDATA[
	  SELECT SERNO,
       ORGANNO,
       BAIL_ACCT_NO,
       BAIL_AMT,
       INPUT_DATE,
       GYLSH,
       BAIL_BALANCE
  FROM IQP_CORE_BAIL_DETAIL
 WHERE BAIL_ACCT_NO IN (SELECT P2.BAIL_ACC_NO
                          FROM IQP_ACTRECPO_MANA P1, IQP_BAILACC_DETAIL P2
                         WHERE P1.PO_NO = P2.PO_NO
                           AND P1.PO_NO = ${po_no}
						   AND p2.cus_id =${buy_cus_id})
                           AND SERNO NOT IN (SELECT TRAN_SERNO FROM R_IQP_ACTREC_REPAY)
  ]]>
    </SELECT>
</SQL>
<!--modified by lisj 2015-2-2 需求编号【HS141110017】保理业务改造 end -->

<!-- 新增应收账款与保证金交易关系  -->
<SQL id="insertRIqpActrecRepay" valueClass="com.ecc.emp.data.KeyedCollection" >
  <INSERT>
  <![CDATA[
   INSERT INTO R_IQP_ACTREC_REPAY(PO_NO,CONT_NO,INVC_NO,TRAN_SERNO,INPUT_DATE) 
     VALUES(${po_no},${cont_no},${invc_no},${tran_serno},${input_date})
  ]]>
  </INSERT>	
</SQL>

<!-- 删除应收账款与保证金交易关系  -->
<SQL id="deleteRIqpActrecRepay" parameterClass="com.ecc.emp.data.KeyedCollection" >
  <DELETE>
  <![CDATA[
   DELETE FROM INTO R_IQP_ACTREC_REPAY WHERE TRAN_SERNO=${tran_serno} AND INVC_NO=${invc_no} AND CONT_NO=${cont_no}
  ]]>
  </DELETE>	
</SQL>

<!-- 发票号与贸易合同编号查询关联的应收账款下回款保证金金额   -->
<SQL id="queryRepayBailAmt" parameterClass="java.util.HashMap" resultClass="com.ecc.emp.data.KeyedCollection">
  <SELECT>
  <![CDATA[
   SELECT NVL(SUM(BAIL_AMT),0) BAIL_AMT FROM IQP_CORE_BAIL_DETAIL WHERE SERNO IN(SELECT TRAN_SERNO FROM R_IQP_ACTREC_REPAY WHERE INVC_NO=${invc_no} AND CONT_NO=${cont_no})
  ]]>
  </SELECT>
</SQL>

<!-- 发票号与贸易合同编号查询关联的应收账款下回款保证金金额   -->
<SQL id="updateActrecStatus" parameterClass="java.util.HashMap" valueClass ="java.lang.String">
  <UPDATE>
  <![CDATA[
   UPDATE IQP_ACTRECBOND_DETAIL SET STATUS='7' WHERE INVC_NO=${invc_no} AND CONT_NO=${cont_no}
  ]]>
  </UPDATE>
</SQL>

<!--- 应收账款明细回款登记   结束  -->
</S>