<?xml version="1.0" encoding="UTF-8"?>
<S>

<!-- 将lmt_name_list和lmt_agr_joint_coop --> lmt_agr_details;-->
<SQL id="insertLmtNameList2Details" parameterClass="java.lang.String"  >
   <UPDATE>
  <![CDATA[  	
insert into Lmt_Agr_Details
  (select (select agr_no from lmt_agr_joint_coop where serno = a.JOINT_GUAR_NO) as LMT_SERNO,
          '03' as SUB_TYPE,  
          a.CUS_ID as cus_id,
          '' as CORE_CORP_CUS_ID,
          '' as CORE_CORP_DUTY,
          a.BAIL_PERC as BAIL_RATE,
          a.LIMIT_TYPE as limit_type,
          a.LIMIT_CODE as limit_code,
          a.LIMIT_NAME as limit_name,
          a.PRD_ID as prd_id,
          a.CUR_TYPE as cur_type,
          a.CRD_AMT as crd_amt,
          '' as FROZE_AMT,
          '' as UNFROZE_AMT,
          '' as ENABLE_AMT,
          a.GUAR_TYPE as GUAR_TYPE,
          a.TEAM_TYPE AS TERM_TYPE,
          a.TEAM AS TERM,
          '' as IS_ADJ_PERIOD,
          '' as IS_PRE_CRD,
          b.start_date as start_date,
         b.end_date as end_date,
          '10' as LMT_STATUS,
          '' as CUS_TYPE,
          (select BIZ_AREA_NO from lmt_agr_biz_area where serno = a.serno) as BIZ_AREA_NO
     from lmt_name_list a, lmt_agr_joint_coop b
    where a.joint_guar_no = b.serno
      and a.name_serno = ${_SIG_VALUE})
  ]]>
   </UPDATE>
</SQL>

<!-- 查询Lmt_App_Join_Back中数据 -->
<SQL id="selectFromLmtAppJoinBack" parameterClass="java.lang.String"  >
 <SELECT>
  <![CDATA[
  select biz_area_no from Lmt_App_Join_Back a where a.app_id=${_SIG_VALUE}
  ]]>
  </SELECT>
</SQL>

<!-- 授信申请分项新增、修改、删除后更新授信申请基表的授信总额、循环额度、一次性额度  
申请分项中数据+当前变更申请对应协议下分项数据去除已经在当前分项中的数据
-->
<SQL id="updateLmtApplyAmt" parameterClass="com.ecc.emp.data.KeyedCollection" >
   <UPDATE>
  <![CDATA[
  	UPDATE LMT_APPLY t
     SET (t.CRD_CIR_AMT,t.CRD_ONE_AMT,t.CRD_TOTL_AMT) = (
      SELECT NVL(SUM(CIR_AMT),0.00),NVL(SUM(ONE_AMT),0.00),NVL(SUM(CIR_AMT+ONE_AMT),0.00) FROM(
        SELECT decode(LIMIT_TYPE,'01',CRD_AMT,0) CIR_AMT ,decode(LIMIT_TYPE,'02',CRD_AMT,0) ONE_AMT FROM(
          SELECT NVL(SUM(CRD_AMT),0.00) CRD_AMT,LIMIT_TYPE FROM LMT_APP_DETAILS WHERE SERNO = ${SERNO}  GROUP BY LIMIT_TYPE
          UNION ALL 
          SELECT NVL(SUM(CRD_AMT),0.00) CRD_AMT,LIMIT_TYPE FROM LMT_AGR_DETAILS
            WHERE AGR_NO = (SELECT AGR_NO FROM LMT_APPLY WHERE SERNO= ${SERNO})
            AND LIMIT_CODE NOT IN(SELECT ORG_LIMIT_CODE FROM LMT_APP_DETAILS WHERE SERNO= ${SERNO}) GROUP BY LIMIT_TYPE
 	))) WHERE SERNO = ${SERNO}
  ]]>
   </UPDATE>
</SQL>

<!-- 授信申请分项新增、修改、删除后根据 授信类别 更新授信申请基表的授信总额、循环额度、一次性额度  
申请分项中数据+当前变更申请对应协议下分项数据去除已经在当前分项中的数据
-->
<SQL id="updateLmtApplyAmt2" parameterClass="com.ecc.emp.data.KeyedCollection" >
   <UPDATE>
  <![CDATA[
  	UPDATE LMT_APPLY t
     SET (t.CRD_CIR_AMT,t.CRD_ONE_AMT,t.CRD_TOTL_AMT) = (
      SELECT NVL(SUM(CIR_AMT),0.00),NVL(SUM(ONE_AMT),0.00),NVL(SUM(CIR_AMT+ONE_AMT),0.00) FROM(
        SELECT decode(LIMIT_TYPE,'01',CRD_AMT,0) CIR_AMT ,decode(LIMIT_TYPE,'02',CRD_AMT,0) ONE_AMT FROM(
          SELECT NVL(SUM(CRD_AMT),0.00) CRD_AMT,LIMIT_TYPE FROM LMT_APP_DETAILS WHERE SERNO = ${SERNO} AND LRISK_TYPE = ${LRISK_TYPE} GROUP BY LIMIT_TYPE
          UNION ALL 
          SELECT NVL(SUM(CRD_AMT),0.00) CRD_AMT,LIMIT_TYPE FROM LMT_AGR_DETAILS
            WHERE AGR_NO = (SELECT AGR_NO FROM LMT_APPLY WHERE SERNO= ${SERNO})
            AND LIMIT_CODE NOT IN(SELECT ORG_LIMIT_CODE FROM LMT_APP_DETAILS WHERE SERNO= ${SERNO}) AND LRISK_TYPE = ${LRISK_TYPE} 
            AND LMT_STATUS='10' AND END_DATE > (SELECT OPENDAY FROM PUB_SYS_INFO) 
            GROUP BY LIMIT_TYPE
 	))) WHERE SERNO = ${SERNO}
  ]]>
   </UPDATE>
</SQL>

<!-- 授信申请分项新增、修改、删除后更新个人授信申请基表的授信总额  -->
<SQL id="updateLmtAppIndivAmt" parameterClass="java.lang.String" >
   <UPDATE>
  <![CDATA[
  	UPDATE LMT_APP_INDIV t
     SET t.CRD_TOTL_AMT = ((SELECT NVL(SUM(CRD_AMT),0.00) FROM LMT_APP_DETAILS WHERE SERNO=T.SERNO) + NVL(t.SELF_AMT,0.00))
     WHERE T.SERNO = ${_SIG_VALUE}
  ]]>
   </UPDATE>
</SQL>

<!-- 根据授信授信流水号查询循环额度、一次性额度-申请  -->
<SQL id="selectLmtAppIndivAmtByApp"  parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" >
   <SELECT>
  <![CDATA[
    SELECT NVL(CRD_CIR_AMT,0.0) CRD_CIR_AMT, NVL(CRD_ONE_AMT,0.0) CRD_ONE_AMT, NVL(CRD_CIR_AMT + CRD_ONE_AMT,0.0)TOTAL_AMT FROM (
	SELECT (SELECT NVL(SUM(CRD_AMT),0.0) FROM LMT_APP_DETAILS WHERE SERNO = ${_SIG_VALUE} AND LIMIT_TYPE='01') CRD_CIR_AMT,
	(SELECT NVL(SUM(CRD_AMT),0.0) FROM LMT_APP_DETAILS WHERE SERNO = ${_SIG_VALUE} AND LIMIT_TYPE='02') CRD_ONE_AMT FROM DUAL
	)
  ]]>
   </SELECT>
</SQL>

<!-- 根据授信授信协议编号查询循环额度、一次性额度-协议  -->
<SQL id="selectLmtAppIndivAmtByAgr"  parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" >
   <SELECT>
  <![CDATA[
   	SELECT NVL(CRD_CIR_AMT,0.0) CRD_CIR_AMT, NVL(CRD_ONE_AMT,0.0) CRD_ONE_AMT, NVL(CRD_CIR_AMT + CRD_ONE_AMT,0.0) TOTAL_AMT,
  	NVL(LRISK_CIR_AMT,0.0) LRISK_CIR_AMT, NVL(LRISK_ONE_AMT,0.0) LRISK_ONE_AMT, NVL(LRISK_CIR_AMT + LRISK_ONE_AMT,0.0) LRISK_TOTAL_AMT FROM (
  	SELECT (SELECT NVL(SUM(CRD_AMT),0.0) FROM LMT_AGR_DETAILS WHERE AGR_NO = ${_SIG_VALUE} AND LIMIT_TYPE='01' AND LRISK_TYPE='20' AND LMT_STATUS<>'30' AND END_DATE > (SELECT OPENDAY FROM PUB_SYS_INFO)) CRD_CIR_AMT,
  	(SELECT NVL(SUM(CRD_AMT),0.0) FROM LMT_AGR_DETAILS WHERE AGR_NO = ${_SIG_VALUE} AND LIMIT_TYPE='02' AND LRISK_TYPE='20' AND LMT_STATUS<>'30' AND END_DATE >= (SELECT OPENDAY FROM PUB_SYS_INFO)) CRD_ONE_AMT,
  	(SELECT NVL(SUM(CRD_AMT),0.0) FROM LMT_AGR_DETAILS WHERE AGR_NO = ${_SIG_VALUE} AND LIMIT_TYPE='01' AND LRISK_TYPE='10' AND LMT_STATUS<>'30' AND END_DATE >= (SELECT OPENDAY FROM PUB_SYS_INFO)) LRISK_CIR_AMT,
  	(SELECT NVL(SUM(CRD_AMT),0.0) FROM LMT_AGR_DETAILS WHERE AGR_NO = ${_SIG_VALUE} AND LIMIT_TYPE='02' AND LRISK_TYPE='10' AND LMT_STATUS<>'30' AND END_DATE >= (SELECT OPENDAY FROM PUB_SYS_INFO)) LRISK_ONE_AMT 
  	FROM DUAL
  )
  ]]>
   </SELECT>
</SQL>

<!-- 根据授信授信协议编号查询循环额度、一次性额度    -用于授信协议查询,不过滤是否到期    2013-12-31 TSY -->
<SQL id="selectLmtAgrAmtByAgr"  parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" >
   <SELECT>
  <![CDATA[
   	SELECT NVL(CRD_CIR_AMT,0.0) CRD_CIR_AMT, NVL(CRD_ONE_AMT,0.0) CRD_ONE_AMT, NVL(CRD_CIR_AMT + CRD_ONE_AMT,0.0) TOTAL_AMT,
  	NVL(LRISK_CIR_AMT,0.0) LRISK_CIR_AMT, NVL(LRISK_ONE_AMT,0.0) LRISK_ONE_AMT, NVL(LRISK_CIR_AMT + LRISK_ONE_AMT,0.0) LRISK_TOTAL_AMT FROM (
  	SELECT (SELECT NVL(SUM(CRD_AMT),0.0) FROM LMT_AGR_DETAILS WHERE AGR_NO = ${_SIG_VALUE} AND LIMIT_TYPE='01' AND LRISK_TYPE='20' AND LMT_STATUS<>'30' AND END_DATE>=(SELECT OPENDAY FROM PUB_SYS_INFO) AND START_DATE<=(SELECT OPENDAY FROM PUB_SYS_INFO)) CRD_CIR_AMT,
  	(SELECT NVL(SUM(CRD_AMT),0.0) FROM LMT_AGR_DETAILS WHERE AGR_NO = ${_SIG_VALUE} AND LIMIT_TYPE='02' AND LRISK_TYPE='20' AND LMT_STATUS<>'30' AND END_DATE>=(SELECT OPENDAY FROM PUB_SYS_INFO) AND START_DATE<=(SELECT OPENDAY FROM PUB_SYS_INFO)) CRD_ONE_AMT,
  	(SELECT NVL(SUM(CRD_AMT),0.0) FROM LMT_AGR_DETAILS WHERE AGR_NO = ${_SIG_VALUE} AND LIMIT_TYPE='01' AND LRISK_TYPE='10' AND LMT_STATUS<>'30' AND END_DATE>=(SELECT OPENDAY FROM PUB_SYS_INFO) AND START_DATE<=(SELECT OPENDAY FROM PUB_SYS_INFO)) LRISK_CIR_AMT,
  	(SELECT NVL(SUM(CRD_AMT),0.0) FROM LMT_AGR_DETAILS WHERE AGR_NO = ${_SIG_VALUE} AND LIMIT_TYPE='02' AND LRISK_TYPE='10' AND LMT_STATUS<>'30' AND END_DATE>=(SELECT OPENDAY FROM PUB_SYS_INFO) AND START_DATE<=(SELECT OPENDAY FROM PUB_SYS_INFO)) LRISK_ONE_AMT 
  	FROM DUAL
  )
  ]]>
   </SELECT>
</SQL>

<!-- 根据授信授信协议编号查询循环额度、一次性额度 - 授信类别（区分条线）   用于做授信新增   2013-12-17  -->
<SQL id="selectLmtAgrDetailsAmtByAgr"  parameterClass="com.ecc.emp.data.KeyedCollection" resultClass="com.ecc.emp.data.KeyedCollection" >
   <SELECT>
  <![CDATA[
   	SELECT NVL(CRD_CIR_AMT,0.0) CRD_CIR_AMT, NVL(CRD_ONE_AMT,0.0) CRD_ONE_AMT, NVL(CRD_CIR_AMT + CRD_ONE_AMT,0.0) TOTAL_AMT,
  	NVL(LRISK_CIR_AMT,0.0) LRISK_CIR_AMT, NVL(LRISK_ONE_AMT,0.0) LRISK_ONE_AMT, NVL(LRISK_CIR_AMT + LRISK_ONE_AMT,0.0) LRISK_TOTAL_AMT FROM (
  	SELECT (SELECT NVL(SUM(CRD_AMT),0.0) FROM LMT_AGR_DETAILS WHERE AGR_NO = ${AGR_NO_1} AND LIMIT_TYPE='01' AND LRISK_TYPE='20' AND LMT_STATUS<>'30' AND END_DATE >= (SELECT OPENDAY FROM PUB_SYS_INFO)) CRD_CIR_AMT,
  	(SELECT NVL(SUM(CRD_AMT),0.0) FROM LMT_AGR_DETAILS WHERE AGR_NO = ${AGR_NO_2} AND LIMIT_TYPE='02' AND LRISK_TYPE='20' AND LMT_STATUS<>'30' AND END_DATE >= (SELECT OPENDAY FROM PUB_SYS_INFO)) CRD_ONE_AMT,
  	(SELECT NVL(SUM(CRD_AMT),0.0) FROM LMT_AGR_DETAILS WHERE AGR_NO = ${AGR_NO_3} AND LIMIT_TYPE='01' AND LRISK_TYPE='10' AND LMT_STATUS<>'30' AND END_DATE >= (SELECT OPENDAY FROM PUB_SYS_INFO)) LRISK_CIR_AMT,
  	(SELECT NVL(SUM(CRD_AMT),0.0) FROM LMT_AGR_DETAILS WHERE AGR_NO = ${AGR_NO_4} AND LIMIT_TYPE='02' AND LRISK_TYPE='10' AND LMT_STATUS<>'30' AND END_DATE >= (SELECT OPENDAY FROM PUB_SYS_INFO)) LRISK_ONE_AMT 
  	FROM DUAL
  )
  ]]>
   </SELECT>
</SQL>


<!-- 集团成员授信申请新增、修改、删除后更新集团授信申请基表的授信总额  -->
<SQL id="updateLmtGrpAppAmt" parameterClass="java.lang.String" >
   <UPDATE>
  <![CDATA[
  	UPDATE LMT_APP_GRP t
     SET t.CRD_TOTL_AMT = (SELECT NVL(SUM(CRD_TOTL_AMT),0.00) FROM LMT_APPLY WHERE GRP_SERNO=T.SERNO)
     WHERE T.SERNO = ${_SIG_VALUE}
  ]]>
   </UPDATE>
</SQL>


<!-- 根据授信申请流水号，删除授信分项中对应的数据  -->
<SQL id="deleteLmtApplyDetails" parameterClass="java.lang.String" >
   <DELETE>
  <![CDATA[
  	DELETE FROM LMT_APP_DETAILS WHERE SERNO = ${_SIG_VALUE}
  ]]>
   </DELETE>
</SQL>

<!-- 根据授信申请流水号，删除授信分项与担保合同关系   -->
<SQL id="deleteRLmtAppGuarCont" parameterClass="java.lang.String" >
   <DELETE>
  <![CDATA[
  	DELETE FROM R_LMT_APP_GUAR_CONT WHERE LIMIT_CODE IN(SELECT ORG_LIMIT_CODE FROM LMT_APP_DETAILS WHERE SERNO = ${_SIG_VALUE}) AND SERNO= ${_SIG_VALUE}
  ]]>
   </DELETE>
</SQL>

<!-- 根据集团授信申请流水号，删除成员授信申请中对应的数据  -->
<SQL id="deleteLmtGrpMemberApp" parameterClass="java.lang.String" >
   <DELETE>
  <![CDATA[
  	DELETE FROM LMT_APPLY WHERE GRP_SERNO = ${_SIG_VALUE}
  ]]>
   </DELETE>
</SQL>

<!-- 根据客户号，加入批量包中 -->
<SQL id="InsertCus2BatchList" parameterClass="java.lang.String" valueClass="java.util.HashMap">
   <INSERT>
     <![CDATA[
         insert into lmt_batch_corre (batch_cus_no,cus_id) values (${batch_cus_no},${cus_id})
     ]]>
   </INSERT>
</SQL>
   <!-- 根据批量客户编号，查询客户具体信息 -->
<SQL id="QueryCusInfo" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.IndexedCollection" >
    <SELECT>
      <![CDATA[
           select * from cus_same_org where cus_no in (select cus_id from lmt_batch_corre where batch_cus_no = ${_SIG_VALUE}) 
      ]]>
    </SELECT>
</SQL>

   <!-- 修改删除担保合同查询授信担保合同关系表此担保合同条数 -->
<SQL id="SelectLmtGuarNum" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
           select (select count(*) from R_Lmt_App_Guar_Cont where guar_cont_no=${_SIG_VALUE})+(select count(*) from R_Lmt_Guar_Cont where guar_cont_no=${_SIG_VALUE}) as num from dual  
      ]]>
    </SELECT>
</SQL>
   <!-- 根据客户编号，查询客户具体信息 -->
<SQL id="QueryCusSameInfo" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.IndexedCollection" >
    <SELECT>
      <![CDATA[
           select * from cus_same_org where cus_no  = ${_SIG_VALUE} 
      ]]>
    </SELECT>
</SQL>

   <!-- 查询是否在圈商或联保下 -->
<SQL id="QueryJointAreaFlag" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
		select joint_serno,app_serno from lmt_name_list where cus_id = ${_SIG_VALUE}
      ]]>
    </SELECT>
</SQL>
<!-- 根据合作方流水号，删除拟按揭设备信息 -->
<SQL id="deleteLmtSchedEquip" parameterClass="java.lang.String" >
    <DELETE>
      <![CDATA[
           DELETE LMT_SCHED_EQUIP WHERE PRO_NO=(SELECT PRO_NO FROM Lmt_Coop_Machine WHERE SERNO = ${_SIG_VALUE})
      ]]>
    </DELETE>
</SQL>
<!-- 根据批量客户编号查询出客户码 -->
<SQL id="querycusid" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
     <SELECT>
     <![CDATA[
           select * from lmt_batch_lmt where serno=${_SIG_VALUE}
     ]]>
     </SELECT>
</SQL>

<!--根据客户码更改客户授信额度状态(提供给系统间接口使用)  2013-08-16  唐顺岩   
2013-12-06 唐顺岩修改：只变更单一法人授信及供应链授信
 -->
<SQL id="updateLmtAgrDetailsStatus" parameterClass="java.lang.String" valueClass="java.lang.String">
   <UPDATE>
  <![CDATA[
  	UPDATE LMT_AGR_DETAILS SET LMT_STATUS = ${_SIG_VALUE} WHERE LMT_STATUS='10' AND SUB_TYPE IN('01','05') AND CUS_ID IN(${_SIG_VALUE})
  ]]>
   </UPDATE>
</SQL>

<!--根据客户码更改客户非低风险授信额度状态(提供给系统间接口使用)  2014-05-12 -->
<SQL id="updateLmtAgrDetailsStatusNL" parameterClass="java.lang.String" valueClass="java.lang.String">
   <UPDATE>
  <![CDATA[
  	UPDATE LMT_AGR_DETAILS SET LMT_STATUS = ${_SIG_VALUE} WHERE LMT_STATUS='10' AND SUB_TYPE IN('01','05') AND CUS_ID IN(${_SIG_VALUE}) AND LRISK_TYPE='20'
  ]]>
   </UPDATE>
</SQL>

<!--  客户条线变更时解除授信与担保合同关系   2013-11-26  唐顺岩 -->
<SQL id="unchainRLmtGuarCont" parameterClass="java.lang.String" valueClass="java.lang.String">
   <UPDATE>
  <![CDATA[
  	UPDATE R_LMT_GUAR_CONT SET CORRE_REL = '3' WHERE LIMIT_CODE IN(SELECT LIMIT_CODE FROM LMT_AGR_DETAILS WHERE LMT_STATUS='10' AND CUS_ID IN(${_SIG_VALUE}))
  ]]>
   </UPDATE>
</SQL>

<!--  授信条线变更时，解除原有台账与担保合同关系   2013-12-09  唐顺岩 -->
<SQL id="unchainRLmtGuarContByAgrNo" parameterClass="com.ecc.emp.data.KeyedCollection" valueClass="java.lang.String">
   <UPDATE>
  <![CDATA[
  	UPDATE R_LMT_GUAR_CONT SET CORRE_REL = '3' WHERE LIMIT_CODE IN(SELECT LIMIT_CODE FROM LMT_AGR_DETAILS WHERE LMT_STATUS='10' AND SUB_TYPE='01' AND AGR_NO = ${AGR_NO} AND LMT_TYPE= ${LMT_TYPE} )
  ]]>
   </UPDATE>
</SQL>
<!--  授信条线变更时，将原有条线台账授信金额、启用金额置为0   2013-12-09  唐顺岩 -->
<SQL id="updateLmtAgrDetailsByAgrNo" parameterClass="com.ecc.emp.data.KeyedCollection" valueClass="java.lang.String">
   <UPDATE>
  <![CDATA[
  	UPDATE LMT_AGR_DETAILS SET CRD_AMT = 0.00,ENABLE_AMT=0.00 WHERE LMT_STATUS='10' AND SUB_TYPE='01' AND AGR_NO = ${AGR_NO} AND LMT_TYPE= ${LMT_TYPE}
  ]]>
   </UPDATE>
</SQL>

<!--根据协议编号更改客户授信额度状态(联保小组解散使用)  2013-11-28  tangzf -->
<SQL id="updateLmtAgrDetailsStatusJont" parameterClass="java.lang.String" valueClass="java.lang.String">
   <UPDATE>
  <![CDATA[
  	UPDATE LMT_AGR_DETAILS SET LMT_STATUS = ${_SIG_VALUE} WHERE AGR_NO=${_SIG_VALUE} AND SUB_TYPE='03'
  ]]>
   </UPDATE>
</SQL>

<!--根据协议编号更改名单客户状态(联保小组解散使用)  2013-12-07  tangzf -->
<SQL id="updateLmtNameListStatusJont" parameterClass="java.lang.String" valueClass="java.lang.String">
   <UPDATE>
  <![CDATA[
  	UPDATE LMT_NAME_LIST SET CUS_STATUS = ${_SIG_VALUE} WHERE AGR_NO=${_SIG_VALUE} AND SUB_TYPE='03'
  ]]>
   </UPDATE>
</SQL>

<!-- 联保小组解散时先查询授信与担保合同关系是否解除   2013-12-19  tangzf -->
<SQL id="checkRLmtGuarContJont" parameterClass="java.lang.String" resultClass="java.lang.String">
   <SELECT>
  <![CDATA[
  	SELECT COUNT(1) cc FROM R_LMT_GUAR_CONT WHERE CORRE_REL <> '3' AND AGR_NO =${_SIG_VALUE}
  ]]>
   </SELECT>
</SQL>

<!-- 根据客户码将其原集团授信变更为单一法人授信（将授信协议的集团授信编号置为空）(提供给系统间接口使用)  2013-08-16  唐顺岩 -->
<SQL id="updateLmtAgrInfo4Single" parameterClass="java.lang.String" >
   <UPDATE>
  <![CDATA[
  	UPDATE LMT_AGR_INFO SET GRP_AGR_NO = '' WHERE CUS_ID IN(${_SIG_VALUE})
  ]]>
   </UPDATE>
</SQL>

<!-- 查询客户存量授信协议 (提供给系统间接口使用)  2013-08-20  唐顺岩 -->
<SQL id="searchLmtAgrInfoList" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
   <SELECT>
  <![CDATA[
  	SELECT AGR_NO,BIZ_TYPE,CUR_TYPE,CRD_TOTL_AMT,CRD_CIR_AMT,CRD_ONE_AMT,START_DATE,END_DATE FROM LMT_AGR_INFO 
  	WHERE CUS_ID = ${_SIG_VALUE} ORDER BY END_DATE DESC
  ]]>
   </SELECT>
</SQL>

<!-- 查询客户存量授信协议 (提供给系统间接口使用)  2013-08-20  唐顺岩 -->
<SQL id="searchLmtOverruleList" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection">
   <SELECT>
  <![CDATA[
  	SELECT SERNO,APP_TYPE,CRD_TOTL_AMT,CRD_CIR_AMT,CRD_ONE_AMT,APP_DATE,INPUT_ID,INPUT_BR_ID FROM LMT_APPLY
  	 WHERE APPROVE_STATUS='998' AND APP_TYPE IN('01','02') AND CUS_ID = ${_SIG_VALUE} ORDER BY APP_DATE DESC
  ]]>
   </SELECT>
</SQL>


<!-- 根据业务编号从担保关联表中取出对应的押品编号 -->
<SQL id="queryGuarNo" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" onlyReturnFirst="false">
   <SELECT>
  <![CDATA[
  	select * from  r_lmt_guar_info where  serno = ${_SIG_VALUE}
  ]]>
   </SELECT>
</SQL>
<!-- 根据业务编号从担保关联表中取出对应的押品编号 -->
<SQL id="queryGuarntrNo" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" onlyReturnFirst="false">
   <SELECT>
  <![CDATA[
  	select * from  r_lmt_guarntr_info where  serno = ${_SIG_VALUE}
  ]]>
   </SELECT>
</SQL>

<!-- 根据客户码、分项类别、额度类型从台账表中取出协议号、授信金额等信息 -->
<SQL id="queryLmtAgrInfoMsg" parameterClass="com.ecc.emp.data.KeyedCollection" resultClass="com.ecc.emp.data.KeyedCollection" onlyReturnFirst="false">
   <SELECT>
  <![CDATA[
  	SELECT A.AGR_NO,SUM(A.CRD_AMT) AS CRD_AMT FROM LMT_AGR_DETAILS A WHERE A.CUS_ID=${cus_id} AND A.SUB_TYPE IN(${sub_type}) AND A.LIMIT_TYPE=${limit_type}
  	AND TO_CHAR(ADD_MONTHS(TO_DATE(A.END_DATE,'yyyy-mm-dd'),6),'yyyy-mm-dd')>(SELECT OPENDAY FROM PUB_SYS_INFO) AND A.LMT_STATUS='10' GROUP BY A.AGR_NO
  ]]>
   </SELECT>
</SQL>


<!-- 根据客户码、分项类型（01-一般授信05-供应链授信）查询授信台账记录 -->
<SQL id="searchLmtAgrDetailsList" parameterClass="com.ecc.emp.data.KeyedCollection" resultClass="com.ecc.emp.data.KeyedCollection" onlyReturnFirst="false">
   <SELECT>
  <![CDATA[
  	SELECT CUS_TYPE,CORE_CORP_CUS_ID,CORE_CORP_DUTY,LIMIT_CODE,LIMIT_NAME,LIMIT_TYPE,GUAR_TYPE,CRD_AMT,CUR_TYPE,START_DATE,END_DATE,LMT_STATUS FROM LMT_AGR_DETAILS A WHERE A.CUS_ID=${cus_id} AND A.SUB_TYPE IN(${sub_type})
  	AND TO_CHAR(ADD_MONTHS(TO_DATE(A.END_DATE,'yyyy-mm-dd'),6),'yyyy-mm-dd')>(SELECT OPENDAY FROM PUB_SYS_INFO) AND A.LMT_STATUS='10'
  ]]>
   </SELECT>
</SQL>


<!-- 根据客户码、分项类型（01-一般授信05-供应链授信）、核心企业客户码（05-供应链授信 时为必传参数）查询授信台账记录 -->
<SQL id="searchLmtAgrDetailsList2" parameterClass="com.ecc.emp.data.KeyedCollection" resultClass="com.ecc.emp.data.KeyedCollection" onlyReturnFirst="false">
   <SELECT>
  <![CDATA[
  	SELECT CUS_TYPE,CORE_CORP_CUS_ID,CORE_CORP_DUTY,LIMIT_CODE,LIMIT_NAME,LIMIT_TYPE,GUAR_TYPE,CRD_AMT,CUR_TYPE,START_DATE,END_DATE,LMT_STATUS FROM LMT_AGR_DETAILS A WHERE A.CUS_ID=${cus_id} AND A.SUB_TYPE IN(${sub_type})
  	AND TO_CHAR(ADD_MONTHS(TO_DATE(A.END_DATE,'yyyy-mm-dd'),6),'yyyy-mm-dd')>(SELECT OPENDAY FROM PUB_SYS_INFO) AND A.LMT_STATUS='10' AND A.CORE_CORP_CUS_ID = ${core_corp_cus_id}
  ]]>
   </SELECT>
</SQL>

<!-- 根据授信品种编码查询单一法人授信额度 -提供给业务办理的查看跟修改页面计算剩余额度  -->
<SQL id="searchSingleLmtAmt" parameterClass="java.lang.String" resultClass="java.math.BigDecimal" onlyReturnFirst="false">
   <SELECT>
  <![CDATA[
  	SELECT (ENABLE_AMT-NVL(FROZE_AMT,0.00)) CRD_AMT FROM LMT_AGR_DETAILS A WHERE A.LIMIT_CODE= ${_SIG_VALUE} 
  	AND TO_CHAR(ADD_MONTHS(TO_DATE(A.END_DATE,'yyyy-mm-dd'),6),'yyyy-mm-dd')>(SELECT OPENDAY FROM PUB_SYS_INFO) AND A.LMT_STATUS='10'
  ]]>
   </SELECT>
</SQL>
<!-- 根据授信品种编码查询同业客户授信额度 -提供给业务办理的查看跟修改页面计算剩余额度  -->
<SQL id="searchIntbankLmtAmt" parameterClass="java.lang.String" resultClass="java.math.BigDecimal" onlyReturnFirst="false">
   <SELECT>
  <![CDATA[
  	SELECT NVL((LMT_AMT-NVL(FROZE_AMT,0.00)),0.00) CRD_AMT FROM LMT_INTBANK_ACC A WHERE A.AGR_NO= ${_SIG_VALUE} 
  	AND TO_CHAR(ADD_MONTHS(TO_DATE(A.END_DATE,'yyyy-mm-dd'),6),'yyyy-mm-dd')>(SELECT OPENDAY FROM PUB_SYS_INFO) AND A.LMT_STATUS='10'
  ]]>
   </SELECT>
</SQL>
<!-- 根据授信品种编码查询第三方授信额度 -提供给业务办理的查看跟修改页面计算剩余额度  -->
<SQL id="searchThirdPartyLmtAmt" parameterClass="java.lang.String" resultClass="java.math.BigDecimal" onlyReturnFirst="false">
   <SELECT>
  <![CDATA[
  	SELECT LMT_TOTL_AMT CRD_AMT FROM LMT_AGR_BIZ_AREA WHERE AGR_NO= ${_SIG_VALUE} 
	UNION ALL 
	SELECT INDUS_AMT CRD_AMT FROM LMT_INDUS_AGR WHERE AGR_NO= ${_SIG_VALUE}
	UNION ALL 
	SELECT LMT_TOTL_AMT CRD_AMT FROM LMT_AGR_JOINT_COOP WHERE AGR_NO= ${_SIG_VALUE}
  ]]>
   </SELECT>
</SQL>

<!-- 行业授信流程后处理begin  -->
<SQL id="dealIndusApp" parameterClass="java.lang.String" >
   <UPDATE>
  <![CDATA[
  	update lmt_indus_APPLY a set a.end_date = (select openday from pub_sys_info  )
  	where serno = ${_SIG_VALUE}
  ]]>
   </UPDATE>
</SQL>
<SQL id="dealListApp" parameterClass="java.lang.String" >
   <UPDATE>
  <![CDATA[
  	update lmt_indus_list_apply a set a.status = '003' where serno = ${_SIG_VALUE}
  ]]>
   </UPDATE>
</SQL>
<SQL id="dealAuthApp" parameterClass="java.lang.String" >
   <UPDATE>
  <![CDATA[
  	update lmt_indus_auth_apply a set a.status = '01' where serno = ${_SIG_VALUE}
  ]]>
   </UPDATE>
</SQL>
<SQL id="indusAppToAgr" parameterClass="java.lang.String" valueClass ="java.lang.String" >
   <UPDATE>
  <![CDATA[
insert into lmt_indus_agr(
 select SERNO , ${_SIG_VALUE} as agr_no , INDUS_TYPE,SHARED_SCOPE,belg_org ,suit_prd , end_date , 
 case when (a.crd_term_type = '001') then to_char(add_months(to_date(a.end_date,'yyyy-mm-dd'), a.crd_term*12),'yyyy-mm-dd')
 when (a.crd_term_type = '002') then to_char(add_months(to_date(a.end_date,'yyyy-mm-dd'), a.crd_term),'yyyy-mm-dd')
 when (a.crd_term_type = '003') then to_char(to_date(a.end_date,'yyyy-mm-dd')+ a.crd_term,'yyyy-mm-dd') end as end_date ,
 CUR_TYPE, INDUS_AMT , SINGLE_AMT , MEMO , MANAGER_BR_ID , MANAGER_ID , INPUT_ID , INPUT_DATE , INPUT_BR_ID , '002',a.is_list_mana
 from lmt_indus_apply a where serno = ${_SIG_VALUE} )
  ]]>
   </UPDATE>
</SQL>
<SQL id="indusListToMana" parameterClass="java.lang.String" valueClass ="java.lang.String" >
   <UPDATE>
  <![CDATA[
 insert into lmt_indus_list_mana(
 select  ${_SIG_VALUE} as agr_no , a.cus_id,a.is_do_limit,a.memo,'003' as status 
 from lmt_indus_list_apply a where serno =  ${_SIG_VALUE})
  ]]>
   </UPDATE>
</SQL>
<SQL id="indusAuthToMana" parameterClass="java.lang.String" valueClass ="java.lang.String" >
   <UPDATE>
  <![CDATA[
 insert into lmt_indus_auth_mana(
 select  ${_SIG_VALUE} as agr_no , a.input_br_id , a.guar_type , a.single_auth_amt , '01' as status 
 from lmt_indus_auth_apply a where serno = ${_SIG_VALUE})
  ]]>
   </UPDATE>
</SQL>
<SQL id="detailsToMana" parameterClass="java.lang.String" valueClass ="java.lang.String" >
   <UPDATE>
  <![CDATA[
insert into Lmt_Agr_Details(select ${_SIG_VALUE} as agr_no , a.sub_type , a.cus_id ,a.core_corp_cus_id 
 ,a.core_corp_duty , a.limit_type, a.limit_code,a.limit_name , a.prd_id ,a.cur_type , a.crd_amt , 
 a.froze_amt,'' as enable_amt , a.guar_type, a.term_type , a.term , a.is_adj_term ,a.is_pre_crd ,
 (select openday from pub_sys_info ) as start_date ,
 case when (a.term_type = '001') then 
   to_char(add_months(to_date((select openday from pub_sys_info ),'yyyy-mm-dd'), a.term*12),'yyyy-mm-dd')
 when (a.term_type = '002') then 
   to_char(add_months(to_date((select openday from pub_sys_info ),'yyyy-mm-dd'), a.term),'yyyy-mm-dd')
 when (a.term_type = '003') 
   then to_char(to_date((select openday from pub_sys_info ),'yyyy-mm-dd')+ a.term,'yyyy-mm-dd') end as end_date,
 '10' ,'',a.lrisk_type from Lmt_App_Details a where serno = ${_SIG_VALUE} )
  ]]>
   </UPDATE>
</SQL>
<SQL id="deleteIndusAgr" parameterClass="java.lang.String" >
   <DELETE>
  <![CDATA[
  	DELETE FROM lmt_indus_agr WHERE agr_no = ${_SIG_VALUE}
  ]]>
   </DELETE>
</SQL>
<SQL id="deleteIndusListMana" parameterClass="java.lang.String" >
   <DELETE>
  <![CDATA[
  	DELETE FROM lmt_indus_list_mana WHERE agr_no = ${_SIG_VALUE}
  ]]>
   </DELETE>
</SQL>
<SQL id="deleteIndusAuthMana" parameterClass="java.lang.String" >
   <DELETE>
  <![CDATA[
  	DELETE FROM lmt_indus_auth_mana WHERE agr_no = ${_SIG_VALUE}
  ]]>
   </DELETE>
</SQL>
<SQL id="deleteAgrDetails" parameterClass="java.lang.String" >
   <DELETE>
  <![CDATA[
  	DELETE FROM Lmt_agr_Details WHERE agr_no = ${_SIG_VALUE}
  ]]>
   </DELETE>
</SQL>
<!-- 行业授信流程后处理end  -->

<!-- 行业协议校验  -->
<SQL id="checkIndusAgr" parameterClass="java.lang.String" resultClass="java.lang.String" >
   <DELETE>
  <![CDATA[
 select count(1)cc from lmt_indus_apply a where a.approve_status not in('997','998')
 and a.indus_type in (select indus_type from lmt_indus_agr where agr_no = ${_SIG_VALUE} )
  ]]>
   </DELETE>
</SQL>

<!-- 名单制管理校验  -->
<SQL id="checkListMana" parameterClass="java.lang.String" resultClass="java.lang.String" >
   <DELETE>
  <![CDATA[
 select count(1)cc from lmt_indus_list_apply where serno = ${_SIG_VALUE} 
  ]]>
   </DELETE>
</SQL>

<!-- 行业类型校验  -->
<SQL id="checkIndusType" parameterClass="java.lang.String" resultClass="java.lang.String" >
   <DELETE>
  <![CDATA[
select count(*)cc from (
 select indus_type  from lmt_indus_apply where approve_status not in ('997','998') union 
 select indus_type from lmt_indus_agr 
 where to_char(add_months(to_date(end_date,'yyyy-mm-dd'),6),'yyyy-mm-dd')>(select openday from pub_sys_info)  
 ) where indus_type = ${_SIG_VALUE}
  ]]>
   </DELETE>
</SQL>

<!-- 行业名单校验  -->
<SQL id="checkIndusList" parameterClass="java.lang.String" resultClass="java.lang.String" >
   <DELETE>
  <![CDATA[
select sum(cc)cc from (
 select count(*)cc from lmt_indus_list_mana where agr_no in (
 select agr_no from lmt_indus_agr  
 where to_char(add_months(to_date(end_date,'yyyy-mm-dd'),6),'yyyy-mm-dd')>(select openday from pub_sys_info) 
 and indus_type not in (select indus_type from lmt_indus_apply where approve_status not in ('990','997','998'))
 ) and cus_id = ${_SIG_VALUE}
 union select count(*)cc from lmt_indus_list_apply where serno in 
 (select serno from lmt_indus_apply where approve_status not in ('990','997','998')) and  cus_id = ${_SIG_VALUE} )
  ]]>
   </DELETE>
</SQL>

<!--  行业名单删除校验    -->
<SQL id="checkDeleteIndusList" parameterClass="java.lang.String" resultClass="java.lang.String" >
   <SELECT>
  <![CDATA[
select count(*)nums from R_BUS_LMTCREDIT_INFO r , Iqp_Loan_App a ,
 (select agr_no,cus_id from lmt_indus_list_mana where cus_id = ${_SIG_VALUE} )l
 where r.agr_no = l.agr_no and a.serno = r.serno  and a.approve_status not in ('997','998')
 and a.cus_id = l.cus_id
  ]]>
   </SELECT>
</SQL>

<!-- 取借据编号  -->
<SQL id="getAgrnoBySerno" parameterClass="java.lang.String" resultClass="java.lang.String" >
   <SELECT>
  <![CDATA[
select agr_no from (select agr_no from lmt_indus_agr a 
 where a.indus_type = (select indus_type from lmt_indus_apply where serno = ${_SIG_VALUE} )
 order by end_date desc ) where rownum = '1' 
  ]]>
   </SELECT>
</SQL>

<!-- 行业授信变更处理begin -->
<SQL id="indusListToApp" parameterClass="java.lang.String" valueClass ="java.lang.String" >
   <UPDATE>
  <![CDATA[  	
 insert into lmt_indus_list_apply(
 select ${_SIG_VALUE} as serno , a.cus_id , a.is_do_limit,a.memo,'001' as status
 from lmt_indus_list_mana a where agr_no = ${_SIG_VALUE})	
  ]]>
   </UPDATE>
</SQL>
<SQL id="indusAuthToApp" parameterClass="java.lang.String" valueClass ="java.lang.String" >
   <UPDATE>
  <![CDATA[  	
 insert into lmt_indus_auth_apply(
 select ${_SIG_VALUE} as serno , a.input_br_id ,a.guar_type , a.single_auth_amt ,'00' as status
 from lmt_indus_auth_mana a where agr_no = ${_SIG_VALUE} )
  ]]>
   </UPDATE>
</SQL>
<!-- 行业授信变更处理end -->

<!-- 授信担保合同等级（一般担保合同） -->
<SQL id="updateRLmtGuarLvlYB" parameterClass="java.util.HashMap"  valueClass ="java.lang.String" > 
    <UPDATE>   
  <![CDATA[
     UPDATE R_LMT_APP_GUAR_CONT A SET A.GUAR_LVL=GUAR_LVL-1 
     WHERE A.LIMIT_CODE=${LIMIT_CODE} AND A.GUAR_LVL>${GUAR_LVL}  
     AND A.GUAR_CONT_NO IN(SELECT GUAR_CONT_NO FROM GRT_GUAR_CONT B WHERE A.GUAR_CONT_NO=B.GUAR_CONT_NO AND B.GUAR_CONT_TYPE='00')
  ]]>
    </UPDATE> 
</SQL>
<!-- 授信担保合同等级（最高额）-->
<SQL id="updateRLmtGuarLvlZGE" parameterClass="java.util.HashMap"  valueClass ="java.lang.String" > 
    <UPDATE>   
  <![CDATA[
     UPDATE R_LMT_APP_GUAR_CONT A SET A.GUAR_LVL=GUAR_LVL-1 
     WHERE A.LIMIT_CODE=${LIMIT_CODE} AND A.GUAR_LVL>${GUAR_LVL}  
     AND A.GUAR_CONT_NO IN(SELECT GUAR_CONT_NO FROM GRT_GUAR_CONT B WHERE A.GUAR_CONT_NO=B.GUAR_CONT_NO AND B.GUAR_CONT_TYPE='01')
  ]]>   
    </UPDATE>
</SQL>

<!-- 授信担保合同等级（最高额）-->
<SQL id="updateRLmtGuarLvlZGENotApp" parameterClass="java.util.HashMap"  valueClass ="java.lang.String" > 
    <UPDATE>   
  <![CDATA[
     UPDATE R_LMT_GUAR_CONT A SET A.GUAR_LVL=GUAR_LVL-1 
     WHERE A.LIMIT_CODE=${LIMIT_CODE} AND A.GUAR_LVL>${GUAR_LVL}  
     AND A.GUAR_CONT_NO IN(SELECT GUAR_CONT_NO FROM GRT_GUAR_CONT B WHERE A.GUAR_CONT_NO=B.GUAR_CONT_NO AND B.GUAR_CONT_TYPE='01')
  ]]>   
    </UPDATE>
</SQL>

<!--  授信项下担保合同签订时实时更新授信启用金额    -->
<SQL id="updateLmtEnableamt" parameterClass="java.lang.String" valueClass ="com.ecc.emp.data.KeyedCollection" >
   <UPDATE>
  <![CDATA[  	
 	UPDATE LMT_AGR_DETAILS SET ENABLE_AMT=(CASE WHEN (NVL(ENABLE_AMT,0)+${guar_amt})>CRD_AMT THEN CRD_AMT ELSE (NVL(ENABLE_AMT,0)+${guar_amt2}) END) WHERE LIMIT_CODE= ${_SIG_VALUE}
 		AND LIMIT_CODE IN(SELECT LIMIT_CODE FROM R_LMT_GUAR_CONT R WHERE LIMIT_CODE=R.LIMIT_CODE AND R.IS_ADD_GUAR='2')
  ]]>
   </UPDATE>
</SQL>

<!--  授信项下担保合同签订时实时更新授信启用金额（分项类型为‘联保时’）    -->
<SQL id="updateLmtEnableamtAgr" parameterClass="java.lang.String" valueClass ="com.ecc.emp.data.KeyedCollection" >
   <UPDATE>
  <![CDATA[  	
 	UPDATE LMT_AGR_DETAILS SET ENABLE_AMT=(CASE WHEN (NVL(ENABLE_AMT,0)+${guar_amt})>CRD_AMT THEN CRD_AMT ELSE (NVL(ENABLE_AMT,0)+${guar_amt2}) END) WHERE AGR_NO= ${_SIG_VALUE}
 		AND AGR_NO IN(SELECT AGR_NO FROM R_LMT_GUAR_CONT R WHERE AGR_NO=R.AGR_NO AND R.IS_ADD_GUAR='2')
  ]]>
   </UPDATE>
</SQL>

<!--  授信项下担保合同注销时实时更新授信启用金额    -->
<SQL id="updateLmtEnableamtOff" parameterClass="java.lang.String" valueClass ="com.ecc.emp.data.KeyedCollection" >
   <UPDATE>
  <![CDATA[  	
 	UPDATE LMT_AGR_DETAILS SET ENABLE_AMT=(CASE WHEN (NVL(ENABLE_AMT,0)-${guar_amt})<0 THEN 0 ELSE (NVL(ENABLE_AMT,0)-${guar_amt2}) END) WHERE LIMIT_CODE= ${_SIG_VALUE}
 		AND LIMIT_CODE IN(SELECT LIMIT_CODE FROM R_LMT_GUAR_CONT R WHERE LIMIT_CODE=R.LIMIT_CODE AND R.IS_ADD_GUAR='2')
  ]]>
   </UPDATE>
</SQL>

<!--  授信项下担保合同注销时实时更新授信启用金额 （分项类型为‘联保时’）  -->
<SQL id="updateLmtEnableamtOffAgr" parameterClass="java.lang.String" valueClass ="com.ecc.emp.data.KeyedCollection" >
   <UPDATE>
  <![CDATA[  	
 	UPDATE LMT_AGR_DETAILS SET ENABLE_AMT=(CASE WHEN (NVL(ENABLE_AMT,0)-${guar_amt})<0 THEN 0 ELSE (NVL(ENABLE_AMT,0)-${guar_amt2}) END) WHERE AGR_NO= ${_SIG_VALUE}
 		AND AGR_NO IN(SELECT AGR_NO FROM R_LMT_GUAR_CONT R WHERE AGR_NO=R.AGR_NO AND R.IS_ADD_GUAR='2')
  ]]>
   </UPDATE>
</SQL>

<!--   更改担保合同与授信台账关系表信息   WHERE GUAR_CONT_NO= ${GUAR_CONT_NO} AND LIMIT_CODE = ${LIMIT_CODE}-->
<SQL id="updateRLmtGuarCont" parameterClass="java.lang.String" valueClass ="java.lang.String" >
   <UPDATE>
  <![CDATA[  	
 	UPDATE R_LMT_GUAR_CONT SET GUAR_AMT=${_SIG_VALUE} WHERE GUAR_CONT_NO= ${_SIG_VALUE}
  ]]>
   </UPDATE>
</SQL>

<!--   更改担保合同与授信分项关系表信息  WHERE GUAR_CONT_NO= ${GUAR_CONT_NO} AND LIMIT_CODE = ${LIMIT_CODE} -->
<SQL id="updateRLmtAppGuarCont" parameterClass="java.lang.String" valueClass ="java.lang.String" >
   <UPDATE>
  <![CDATA[  	
 	UPDATE R_LMT_APP_GUAR_CONT SET GUAR_AMT=${_SIG_VALUE} WHERE GUAR_CONT_NO= ${_SIG_VALUE}
  ]]>
   </UPDATE>
</SQL>

<!--  根据授信额度编号查询关联担保合同     -->
<SQL id="searchGuarContByLimitCode" parameterClass="com.ecc.emp.data.KeyedCollection" resultClass="com.ecc.emp.data.IndexedCollection" >
   <SELECT>
  <![CDATA[
 	SELECT * FROM R_LMT_GUAR_CONT WHERE LIMIT_CODE IN(${limitCodeStr})
  ]]>
   </SELECT>
</SQL>

<!--  根据担保合同编号查询担保合同与授信台账关系表是否阶段担保及是否追加     -->
<SQL id="searchGuarContByGuarCont" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" >
   <SELECT>
  <![CDATA[
 	SELECT DISTINCT IS_PER_GUR,IS_ADD_GUAR FROM R_LMT_GUAR_CONT WHERE GUAR_CONT_NO = ${_SIG_VALUE}
  ]]>
   </SELECT>
</SQL>

<!--  根据担保合同编号查询担保合同与授信申请关系表是否阶段担保及是否追加     -->
<SQL id="searchAppGuarContByGuarCont" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" >
   <SELECT>
  <![CDATA[
 	SELECT DISTINCT IS_PER_GUR,IS_ADD_GUAR FROM R_LMT_APP_GUAR_CONT WHERE GUAR_CONT_NO = ${_SIG_VALUE}
  ]]>
   </SELECT>
</SQL>

<!--  根据联保授信协议查询联保小组成员信息    -->
<SQL id="searchLmtJointNameList" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" >
   <SELECT>
  <![CDATA[
 	SELECT AGR_NO,SUB_TYPE,CUS_ID,BAIL_RATE,IS_LIMIT_SET FROM LMT_NAME_LIST WHERE CUS_STATUS='1' AND AGR_NO = ${_SIG_VALUE}
  ]]>
   </SELECT>
</SQL>

<!--  生成联保授信协议与担保合同关系  -->
<SQL id="createRLmtGuarContByJoint" parameterClass="java.lang.String" valueClass="com.ecc.emp.data.KeyedCollection" >
   <INSERT>
  <![CDATA[
 	INSERT INTO R_LMT_GUAR_CONT(LIMIT_CODE,AGR_NO,GUAR_CONT_NO,IS_PER_GUR,GUAR_AMT,CORRE_REL,IS_ADD_GUAR,GUAR_LVL) VALUES(
 	${LIMIT_CODE},${AGR_NO},${GUAR_CONT_NO},${IS_PER_GUR},${GUAR_AMT},${CORRE_REL},${IS_ADD_GUAR},${GUAR_LVL}
 	)
  ]]>
   </INSERT>
</SQL>
<!--  更新联保授信协议与担保合同关系 ,IS_PER_GUR=${IS_PER_GUR},IS_ADD_GUAR=${IS_ADD_GUAR} -->
<SQL id="updateRLmtGuarContByJoint" parameterClass="com.ecc.emp.data.KeyedCollection" valueClass="com.ecc.emp.data.KeyedCollection" >
   <UPDATE>
  <![CDATA[
 	UPDATE R_LMT_GUAR_CONT SET AGR_NO=${AGR_NO},GUAR_AMT=${GUAR_AMT},CORRE_REL=${CORRE_REL},GUAR_LVL=${GUAR_LVL}
 	 WHERE LIMIT_CODE=${LIMIT_CODE} AND GUAR_CONT_NO=${GUAR_CONT_NO} 
  ]]>
   </UPDATE>
</SQL>
<!--  授信变更时将原有台账与担保合同关系复制给新的授信申请    -->
<SQL id="createRLmtAppGuarContRecord" parameterClass="java.lang.String" valueClass ="com.ecc.emp.data.KeyedCollection">
   <INSERT>
  <![CDATA[
 	INSERT INTO R_LMT_APP_GUAR_CONT SELECT ${LIMIT_CODE},${AGR_NO},GUAR_CONT_NO,IS_PER_GUR,GUAR_AMT,'4',IS_ADD_GUAR,GUAR_LVL FROM R_LMT_GUAR_CONT WHERE LIMIT_CODE =${_SIG_VALUE} AND CORRE_REL<>'3'
  ]]>
   </INSERT>
</SQL>

<!--  授信申请审批通过时将授信与担保合同关系表数据复制给授信台账与担保合同关系表    -->
<SQL id="createRLmtGuarContRecord" parameterClass="com.ecc.emp.data.KeyedCollection" valueClass ="com.ecc.emp.data.KeyedCollection">
   <INSERT>
  <![CDATA[
 	INSERT INTO R_LMT_GUAR_CONT SELECT ${LIMIT_CODE},${AGR_NO},GUAR_CONT_NO,IS_PER_GUR,GUAR_AMT,CORRE_REL,IS_ADD_GUAR,GUAR_LVL FROM R_LMT_APP_GUAR_CONT WHERE LIMIT_CODE =${LIMIT_CODE} AND SERNO = ${SERNO} 
  ]]>
   </INSERT>
</SQL>

<!--  授信协议生成时同步更新分项与担保合同关系表    -->
<SQL id="updateRLmtAppGuarContRecord" parameterClass="java.lang.String" valueClass ="java.lang.String">
   <UPDATE>
  <![CDATA[
 	UPDATE R_LMT_GUAR_CONT SET AGR_NO= ${_SIG_VALUE} WHERE LIMIT_CODE =${_SIG_VALUE}
  ]]>
   </UPDATE>
</SQL>

<!-- 根据授信协议号获取授信台账的冻结金额汇总  -->
<SQL id="queryFrozeAmtByAgrNo" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
      	   select nvl(sum(a.froze_amt),0) agr_froze_amt from lmt_agr_details a where a.agr_no = ${_SIG_VALUE} group by a.agr_no
      ]]>
    </SELECT>
</SQL>

<!-- 根据授信额度编码串查询授信额度详细信息     增加总行冻结金额，20140804 唐顺岩   需求编号：XD140630018  -->
<SQL id="queryLmtAgrDetailsByLimitCodeStr" parameterClass="com.ecc.emp.data.KeyedCollection" resultClass="com.ecc.emp.data.IndexedCollection" >
    <SELECT>
      <![CDATA[
      	   SELECT AGR_NO,CUS_ID,LIMIT_CODE,LIMIT_TYPE,LIMIT_NAME,CUR_TYPE,CRD_AMT,ENABLE_AMT,FROZE_AMT,FROZE_AMT_HQ,GUAR_TYPE,START_DATE,END_DATE,lrisk_type,sub_type FROM LMT_AGR_DETAILS WHERE LIMIT_CODE IN(${limitCodeStr})
      ]]>
    </SELECT>
</SQL>

<!--  变更保存时将原有授信台账复制到申请分项历史表     -->
<SQL id="createLmtAppDetailsHisRecord" parameterClass="com.ecc.emp.data.KeyedCollection" valueClass="com.ecc.emp.data.KeyedCollection">
   <INSERT>
  <![CDATA[
 	INSERT INTO LMT_APP_DETAILS_HIS SELECT ${SERNO},SUB_TYPE,CUS_ID,CORE_CORP_CUS_ID,CORE_CORP_DUTY,LIMIT_TYPE,LIMIT_CODE,LIMIT_NAME,PRD_ID,
 	CUR_TYPE,CRD_AMT,FROZE_AMT,ENABLE_AMT,GUAR_TYPE,TERM_TYPE,TERM,IS_ADJ_TERM,IS_PRE_CRD,START_DATE,END_DATE,CUS_TYPE,LMT_STATUS,AGR_NO,LRISK_TYPE,
 	'',GREEN_INDUS,GREEN_PRO_TYPE 
 	FROM LMT_AGR_DETAILS WHERE AGR_NO = ${AGR_NO} AND LRISK_TYPE = ${LRISK_TYPE} AND LMT_STATUS='10'
  ]]>
   </INSERT>
</SQL>

<!--  变更保存时将原有授信协议复制到申请历史表     -->
<SQL id="createLmtApplyRecord" parameterClass="java.lang.String" valueClass="java.lang.String">
   <INSERT>
  <![CDATA[
 	INSERT INTO LMT_APP_GRP_MEM_HIS SELECT ${_SIG_VALUE},AGR_NO,GRP_AGR_NO,CUS_ID,BIZ_TYPE,CUR_TYPE,CRD_TOTL_AMT,CRD_CIR_AMT,CRD_ONE_AMT,START_DATE,
 	END_DATE,MEMO,MANAGER_ID,MANAGER_BR_ID,INPUT_ID,INPUT_BR_ID,INPUT_DATE,AGR_STATUS FROM LMT_AGR_INFO WHERE GRP_AGR_NO =${_SIG_VALUE} AND AGR_STATUS='002'
  ]]>
   </INSERT>
</SQL>

<!--*************** 限额管理begin ****************-->
<!--  限额产品代码校验  -->
<SQL id="prdIdCheck" parameterClass="java.util.HashMap" resultClass="java.lang.String">
    <SELECT>
  <![CDATA[
select to_char(LISTAGG(prd_id,',') within group(order by prd_id)) as prd_id from Lmt_Quota_Manager 
 where code_id = ${code_id} and serno !=  ${serno}
  ]]>
    </SELECT>
</SQL>
<!--*************** 限额管理end ****************-->

<!-- 根据流水号获取个人额度申请中个人及配偶客户号、保证人及配偶客户号、共同债务人及配偶客户号 -->
<SQL id="queryCusIdForIndivByLmtSerno" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
           select cus_id
  			from cus_base
 			where cus_id in
       				((select cus_id from lmt_app_indiv where serno = ${_SIG_VALUE})
        			union (select same_debtor_id
                 			from lmt_app_indiv
                			where serno = ${_SIG_VALUE}) 
                	union (select d.cus_id
           					from lmt_app_details     a,
                			r_lmt_app_guar_cont b,
                			grt_guaranty_re     c,
                			grt_guarantee       d
          					where a.serno = ${_SIG_VALUE}
            				and a.limit_code = b.limit_code
            				and b.guar_cont_no = c.guar_cont_no
            				and c.guaranty_id = d.guar_id) 
            		union (select cus_id_rel
           					from cus_indiv_soc_rel
          					where indiv_cus_rel = '1'
            				and cus_id in (select cus_id
                             from lmt_app_indiv
                            where serno = ${_SIG_VALUE})) 
                    union (select cus_id_rel
           					from cus_indiv_soc_rel
          					where indiv_cus_rel = '1'
            				and cus_id in (select same_debtor_id
                             from lmt_app_indiv
                            where serno = ${_SIG_VALUE})) 
                   	union (select cus_id_rel
           					from cus_indiv_soc_rel
          					where indiv_cus_rel = '1'
            				and cus_id in
                			(select d.cus_id
                   			from lmt_app_details     a,
                        	r_lmt_app_guar_cont b,
                        	grt_guaranty_re     c,
                        	grt_guarantee       d
          					where a.serno = ${_SIG_VALUE}
            				and a.limit_code = b.limit_code
            				and b.guar_cont_no = c.guar_cont_no
            				and c.guaranty_id = d.guar_id)))
   			and cus_status = '20'
   			and cus_id not in (select cus_id
                        from cus_blk_list
                       where black_level = '3'
                         and status in ('002', '004')
                         and cus_id is not null)
            and belg_line = 'BL300'
      ]]>
    </SELECT>
</SQL>
<!-- 根据授信品种编号获取授信下的担保编号列表 -->
<SQL id="queryGuarNoListByLimiCodeList" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.IndexedCollection" >
    <SELECT>
      <![CDATA[
          select guar_cont_no from r_lmt_guar_cont where limit_code in (${_SIG_VALUE})
      ]]>
    </SELECT>
</SQL>

<!-- 提供业务授信审批意见的serno(对公)-->
<SQL id="getSernoForIqpCom" parameterClass="java.lang.String" resultClass ="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
          SELECT SERNO FROM LMT_AGR_INFO WHERE AGR_NO=(SELECT AGR_NO FROM LMT_AGR_DETAILS WHERE LIMIT_CODE=${_SIG_VALUE})
      ]]>
    </SELECT>
</SQL>
<!-- 提供业务授信审批意见的serno(个人)-->
<SQL id="getSernoForIqpPer" parameterClass="java.lang.String" resultClass ="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
          SELECT SERNO FROM LMT_AGR_INDIV  WHERE AGR_NO=(SELECT AGR_NO FROM LMT_AGR_DETAILS WHERE LIMIT_CODE=${_SIG_VALUE})
      ]]>
    </SELECT>
</SQL>

<!-- 提供业务授信审批意见的serno(联保)-->
<SQL id="getSernoForJoint" parameterClass="java.lang.String" resultClass ="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
          SELECT SERNO FROM LMT_AGR_JOINT_COOP  WHERE COOP_TYPE='010' AND AGR_NO=(SELECT AGR_NO FROM LMT_AGR_DETAILS WHERE LIMIT_CODE=${_SIG_VALUE})
      ]]>
    </SELECT>
</SQL>

<!-- 提供业务授信审批意见的serno(合作方和第三方)-->
<SQL id="getSernoForIqp" parameterClass="java.lang.String" resultClass ="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
          SELECT SERNO FROM LMT_AGR_JOINT_COOP WHERE  COOP_TYPE<>'010' AND AGR_NO=${_SIG_VALUE}
          UNION ALL
		  SELECT SERNO FROM LMT_INDUS_AGR WHERE AGR_NO=${_SIG_VALUE}
		  UNION ALL
	      SELECT SERNO FROM LMT_AGR_BIZ_AREA WHERE AGR_NO=${_SIG_VALUE}
		  UNION ALL
		  SELECT SERNO FROM LMT_AGR_INFO WHERE AGR_NO=(SELECT AGR_NO FROM LMT_AGR_DETAILS WHERE LIMIT_CODE=${_SIG_VALUE} AND INSTR(PRD_ID,'300020')>0)
      ]]>
    </SELECT>
</SQL>

<!--  根据授信协议号或者台账编号查询授信类型    -->
<SQL id="viewLmtAgrInfoOp" parameterClass="java.lang.String" resultClass="java.lang.String" >
    <SELECT>
      <![CDATA[
        SELECT 'JOINT' LX FROM LMT_AGR_JOINT_COOP WHERE AGR_NO=(SELECT AGR_NO FROM LMT_AGR_DETAILS WHERE LIMIT_CODE=${_SIG_VALUE}) AND COOP_TYPE ='010'
		UNION ALL 
		SELECT 'COOP' LX FROM LMT_AGR_JOINT_COOP WHERE AGR_NO=${_SIG_VALUE} AND COOP_TYPE <> '010'
		UNION ALL 
		SELECT 'BIZARE' LX FROM LMT_AGR_BIZ_AREA WHERE AGR_NO=${_SIG_VALUE}
		UNION ALL 
		SELECT 'INDUS' LX FROM LMT_INDUS_AGR WHERE AGR_NO=${_SIG_VALUE}
		UNION ALL 
		SELECT 'INDIV' LX FROM LMT_AGR_INDIV WHERE AGR_NO =(SELECT AGR_NO FROM LMT_AGR_DETAILS WHERE LIMIT_CODE=${_SIG_VALUE})
		UNION ALL 
		SELECT 'COM' LX FROM LMT_AGR_INFO WHERE AGR_NO =(SELECT AGR_NO FROM LMT_AGR_DETAILS WHERE LIMIT_CODE=${_SIG_VALUE})
        UNION ALL 
		SELECT 'SAME' LX FROM LMT_INTBANK_ACC WHERE AGR_NO=${_SIG_VALUE}
      ]]>
    </SELECT>
</SQL>

<!-- 根据圈商协议编号获取圈商信息(圈商)-->
<SQL id="getLmtAgrBizArea" parameterClass="java.lang.String" resultClass ="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
          SELECT * FROM LMT_AGR_BIZ_AREA WHERE AGR_NO=${_SIG_VALUE}
      ]]>
    </SELECT>
</SQL>

<!-- 根据圈商协议编号获取圈商成员信息(圈商)-->
<SQL id="getLmtAgrBizAreaMember" parameterClass="java.lang.String" resultClass ="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
          SELECT * FROM LMT_NAME_LIST WHERE AGR_NO=${_SIG_VALUE} AND CUS_STATUS='1'
      ]]>
    </SELECT>
</SQL>

<!-- 根据合作方客户码获取合作方信息-->
<SQL id="getAgrCoopInfo" parameterClass="java.lang.String" resultClass ="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
          select * from Lmt_Agr_Joint_Coop a where a.cus_id=${_SIG_VALUE} and a.agr_status='002'
      ]]>
    </SELECT>
</SQL>

<!-- 根据担保合同编号查询未解除的记录数-->
<SQL id="getLmtCountsByGuarContNo" parameterClass="java.lang.String" resultClass ="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
          select count(*) as counts from Grt_Loan_R_Gur a where a.corre_rel='3' and a.guar_cont_no = ${_SIG_VALUE}
      ]]>
    </SELECT>
</SQL>

<!-- 根据担保合同编号获取其与授信关联信息  -->
<SQL id="getLmtGuarReByGuarContNo" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" >
   <SELECT>
  <![CDATA[
 select * from r_lmt_app_guar_cont a where a.limit_code||a.guar_cont_no not in (select b.limit_code||b.guar_cont_no from r_lmt_guar_cont b) and a.guar_cont_no=${_SIG_VALUE}
 union 
 select limit_code,'',guar_cont_no,is_per_gur,guar_amt,corre_rel,is_add_guar,guar_lvl from r_lmt_guar_cont where guar_cont_no=${_SIG_VALUE} 
  ]]>
   </SELECT>
</SQL>

<!-- 根据担保合同编号获取其与授信关联信息 （申请表） -->
<SQL id="getLmtAppGuarReByGuarContNo" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" >
   <SELECT>
  <![CDATA[
 select * from r_lmt_app_guar_cont a where a.limit_code||a.guar_cont_no not in (select b.limit_code||b.guar_cont_no from r_lmt_guar_cont b) and a.guar_cont_no=${_SIG_VALUE}
  ]]>
   </SELECT>
</SQL>
<!-- 根据客户经理id查询授信总金额 add by tangzf 2014.01.10 -->
<SQL id="getIndivLmtAmtByMgrId" parameterClass="com.ecc.emp.data.KeyedCollection" resultClass ="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
          select nvl(sum(crd_amt),0) as amt_tol from lmt_agr_details a where a.end_date>${openDay} and a.agr_no in (select agr_no from lmt_agr_indiv b where b.manager_id=${managerId}) and agr_no not in 
          (select agr_no from lmt_agr_indiv where cus_id=${cusId} and manager_id=${managerId})
      ]]>
    </SELECT>
</SQL>

<!-- 根据客户经理id查询在途授信总金额 add by tangzf 2014.01.10 -->
<SQL id="getIndivLmtWayAmtByMgrId" parameterClass="com.ecc.emp.data.KeyedCollection" resultClass ="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
          select nvl(sum(crd_amt),0) as amt_tol from lmt_app_details a where a.serno in (select serno from lmt_app_indiv b where b.manager_id=${managerId} and b.approve_status not in ('997','998') and b.serno<>${serno}) 
      ]]>
    </SELECT>
</SQL>

<!-- 根据主管机构id查询授信总金额 add by tangzf 2014.01.10 -->
<SQL id="getIndivLmtAmtByOrgId" parameterClass="com.ecc.emp.data.KeyedCollection" resultClass ="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
          select nvl(sum(crd_amt),0) as amt_tol from lmt_agr_details a where a.end_date>${openDay} and a.agr_no in (select agr_no from lmt_agr_indiv b where b.manager_br_id=${managerBrId}) and agr_no not in 
          (select agr_no from lmt_agr_indiv where cus_id=${cusId} and manager_br_id=${managerBrId})
      ]]>
    </SELECT>
</SQL>

<!-- 根据主管机构id查询在途授信总金额 add by tangzf 2014.01.10 -->
<SQL id="getIndivLmtWayAmtByOrgId" parameterClass="com.ecc.emp.data.KeyedCollection" resultClass ="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
          select nvl(sum(crd_amt),0) as amt_tol from lmt_app_details a where a.serno in (select serno from lmt_app_indiv b where b.manager_br_id=${managerBrId} and b.approve_status not in ('997','998') and b.serno<>${serno}) 
      ]]>
    </SELECT>
</SQL>

<!-- 根据serno查询授信总金额 -->
<SQL id="getIndivLmtAmtBySerno" parameterClass="java.lang.String" resultClass ="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
          select nvl(sum(crd_amt),0) as amt_tol from lmt_app_details a where a.serno=${_SIG_VALUE}
      ]]>
    </SELECT>
</SQL>

<!-- 根据担保合同编号删除担保合同与授信关联关系表记录（结果表）-->
	<SQL id="deleteRLmtGuarCont" parameterClass="java.lang.String">
	  <DELETE>
	  <![CDATA[
		delete from r_lmt_guar_cont where guar_cont_no=${_SIG_VALUE}
	  ]]>
	  </DELETE>
	</SQL>
	
<!-- 根据担保合同编号删除担保合同与授信关联关系表记录（结果表）-->
	<SQL id="updateLmtGuarStatus" parameterClass="java.lang.String">
	  <UPDATE>
	  <![CDATA[
		update r_lmt_guar_cont set corre_rel='3' where guar_cont_no=${_SIG_VALUE}
	  ]]>
	  </UPDATE>
	</SQL>

<!-- 根据集团授信申请否决时根据编号更新集团成员授信申请状态  add by tangzf 2014.04.10-->
<SQL id="updateLmtGrpApproveStatus" parameterClass="java.lang.String" valueClass="java.lang.String">
  <UPDATE>
  <![CDATA[
	update lmt_apply set approve_status=${_SIG_VALUE} where grp_serno=${_SIG_VALUE}
  ]]>
  </UPDATE>
</SQL>

<!-- 根据融资性担保公司代偿申请编号查询代偿台账详情 add by tangzf 2014.04.11 -->
<SQL id="getSubpayBillInfoBySerno" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
		select a.pk, a.serno, a.subpay_bill_no, b.cont_no, b.prd_id, b.bill_amt, b.bill_bal, (b.inner_owe_int + b.out_owe_int) as int_cumu,a.subpay_cap,a.subpay_int
		from lmt_subpay_list a, acc_view b
		where a.subpay_bill_no = b.bill_no and a.serno = ${_SIG_VALUE}
      ]]>
    </SELECT>
</SQL>

<!-- 获取最新泉水贷授信金额  -->
<SQL id="queryCrdAmtByOrgLimitCodeForQsd" parameterClass="java.lang.String" valueClass="java.lang.String" resultClass="java.math.BigDecimal" onlyReturnFirst="false" >
   <SELECT>
  <![CDATA[
	select a.crd_amt from lmt_qsd_info a,lmt_app_indiv b where a.org_limit_code = ${_SIG_VALUE} and a.serno = b.serno and b.approve_status = '997' order by a.inure_time desc 
  ]]>
   </SELECT>
</SQL>
<!--modified by lisj 2015-7-14  需求编号：【XD150710050】信贷业务纸质档案封面的导出与打印功能变更 -->
<!--add by lisj 2015-6-10 需求编号:【XD150107002】新增信贷业务纸质档案封面的导出与打印功能 ,单一法人/个人-->
<SQL id="queryLmtAppJuralInfo" parameterClass="com.ecc.emp.data.KeyedCollection" resultClass="com.ecc.emp.data.KeyedCollection" >
   <SELECT>
  <![CDATA[
           select limit_code, guar_cont_no, guar_cont_cn_no, cus_name, guar_start_date, guar_end_date, guar_id,guar_amt
  from (select p2.limit_code,
               p3.guar_cont_no,
               p3.guar_cont_cn_no,
               (select t4.prdname
                  from lmt_agr_details t2, prd_basicinfo t4
                 where t2.limit_name = t4.prdid
                   and t2.limit_code = p2.limit_code) prdname,
               p5.cus_id,
               p5.guar_id,
               (select t3.cus_name
                  from cus_base t3
                 where t3.cus_id = p5.cus_id) cus_name,
               p5.guar_amt,
               p3.guar_start_date,
               p3.guar_end_date
          from lmt_agr_indiv   p1,
               r_lmt_guar_cont p2,
               grt_guar_cont   p3,
               grt_guaranty_re p4,
               grt_guarantee   p5,
               lmt_agr_details p6
         where p1.agr_no = p2.agr_no
           and p2.guar_cont_no = p3.guar_cont_no
           and p3.guar_cont_no = p4.guar_cont_no
           and p4.guaranty_id = p5.guar_id
           and p2.corre_rel <> '3'
           and p6.limit_code = p2.limit_code
	       and p6.lmt_status <>'30'
           and p1.agr_no = ${agrNo}
           and exists (select 1
                  from grt_guar_cont t1
                 where t1.guar_cont_no = p2.guar_cont_no
                   and t1.guar_cont_state = '01'
                   and t1.guar_way not in ('00', '01'))
        union all
        select p2.limit_code,
               p3.guar_cont_no,
               p3.guar_cont_cn_no,
               (select t4.prdname
                  from lmt_agr_details t2, prd_basicinfo t4
                 where t2.limit_name = t4.prdid
                   and t2.limit_code = p2.limit_code) prdname,
               p5.cus_id,
               p5.guar_id,
               (select t3.cus_name
                  from cus_base t3
                 where t3.cus_id = p5.cus_id) cus_name,
               p5.guar_amt,
               p3.guar_start_date,
               p3.guar_end_date
          from lmt_agr_info    p1,
               r_lmt_guar_cont p2,
               grt_guar_cont   p3,
               grt_guaranty_re p4,
               grt_guarantee   p5,
               lmt_agr_details p6
         where p1.agr_no = p2.agr_no
           and p2.guar_cont_no = p3.guar_cont_no
           and p3.guar_cont_no = p4.guar_cont_no
           and p4.guaranty_id = p5.guar_id
           and p2.corre_rel <> '3'
           and p6.limit_code = p2.limit_code
	       and p6.lmt_status <>'30'
           and p1.agr_no = ${agrNo}
           and exists (select 1
                  from grt_guar_cont t1
                 where t1.guar_cont_no = p2.guar_cont_no
                   and t1.guar_cont_state = '01'
                   and t1.guar_way not in ('00', '01')))
  ]]>
   </SELECT>
</SQL>
<!--modified by lisj 2015-7-14  需求编号：【XD150710050】信贷业务纸质档案封面的导出与打印功能变更 -->
<!--add by lisj 2015-6-10 需求编号:【XD150107002】新增信贷业务纸质档案封面的导出与打印功能 ,集团-->
<SQL id="queryLmtGrpJuralInfo" parameterClass="com.ecc.emp.data.KeyedCollection" resultClass="com.ecc.emp.data.KeyedCollection" >
   <SELECT>
  <![CDATA[
         select p2.limit_code,
       p3.guar_cont_no,
       p3.guar_cont_cn_no,
       p5.cus_id,
       p5.guar_id,
       p5.guar_amt,
       p3.guar_start_date,
       p3.guar_end_date,
       (select t4.prdname
          from lmt_agr_details t2, prd_basicinfo t4
         where t2.limit_name = t4.prdid
           and t2.limit_code = p2.limit_code) prdname, 
       (select t3.cus_name from cus_base t3 where t3.cus_id = p5.cus_id) cus_name from lmt_agr_grp p1,
       lmt_agr_info    p6,
       r_lmt_guar_cont p2,
       grt_guar_cont   p3,
       grt_guaranty_re p4,
       grt_guarantee   p5
       lmt_agr_details p7
 where p1.grp_agr_no = p6.grp_agr_no
   and p6.agr_no = p2.agr_no
   and p2.guar_cont_no = p3.guar_cont_no
   and p3.guar_cont_no = p4.guar_cont_no
   and p4.guaranty_id = p5.guar_id
   and p2.corre_rel <> '3'
   and p7.limit_code = p2.limit_code
   and p7.lmt_status <>'30'
   and p1.grp_agr_no =${agrNo}
   and exists (select 1
          from grt_guar_cont t1
         where t1.guar_cont_no = p2.guar_cont_no
           and t1.guar_cont_state = '01'
           and t1.guar_way not in ('00', '01')) ORDER BY p2.limit_code
  ]]>
   </SELECT>
</SQL>
<!--modified by lisj 2015-7-14  需求编号：【XD150710050】信贷业务纸质档案封面的导出与打印功能变更 -->
<!--add by lisj 2015-6-10 需求编号:【XD150107002】新增信贷业务纸质档案封面的导出与打印功能 ,联保-->
<SQL id="queryLmtJointJuralInfo" parameterClass="com.ecc.emp.data.KeyedCollection" resultClass="com.ecc.emp.data.KeyedCollection" >
   <SELECT>
  <![CDATA[
          select distinct p1.agr_no,
       p2.guar_cont_no,
       p3.guar_cont_cn_no,
       p2.limit_code,
       (select t4.prdname
          from lmt_agr_details t2, prd_basicinfo t4
         where t2.limit_name = t4.prdid
           and t2.limit_code = p2.limit_code) prdname,
       p5.cus_id,
       p5.guar_id,
       (select t3.cus_name from cus_base t3 where t3.cus_id = p5.cus_id) cus_name,
       p5.guar_amt,
       p3.guar_start_date,
       p3.guar_end_date
  from lmt_agr_joint_coop   p1,
       r_lmt_guar_cont p2,
       grt_guar_cont   p3,
       grt_guaranty_re p4,
       grt_guarantee   p5,
       lmt_agr_details p6
 where p1.agr_no = p2.agr_no
   and p2.guar_cont_no = p3.guar_cont_no
   and p3.guar_cont_no = p4.guar_cont_no
   and p4.guaranty_id = p5.guar_id
   and p2.corre_rel <> '3'
   and p6.limit_code = p2.limit_code
   and p6.lmt_status <>'30'
   and p1.agr_no =${agrNo}
   and p6.cus_id = ${cusId}
   and p5.cus_id <> ${cusId}
   and exists (select 1
          from grt_guar_cont t1
         where t1.guar_cont_no = p2.guar_cont_no
           and t1.guar_cont_state = '01'
           and t1.guar_way not in ('00', '01'))
         order by p2.limit_code
  ]]>
   </SELECT>
</SQL>

<!--add by lisj 2015-7-22  需求编号：【XD150710050】信贷业务纸质档案封面的导出与打印功能变更  begin-->
<SQL id="queryLmtAppJuralInfo4clc" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" >
   <SELECT>
  <![CDATA[
   select distinct p1.guar_cont_no,
       p1.guar_cont_cn_no,
       p1.guar_start_date,
       p1.guar_end_date,
       p1.guar_cont_state,
       p5.guar_amt,
       p5.cus_id,
       p5.guar_id,
       (select cb.cus_name from cus_base cb where cb.cus_id = p5.cus_id) as cus_name
  from grt_guar_cont   p1,
       grt_loan_r_gur  p2,
       ctr_loan_cont   p3,
       grt_guaranty_re p4,
       grt_guarantee   p5
 where p1.guar_cont_no = p2.guar_cont_no
   and p2.cont_no = p3.cont_no
   and p1.cus_id = p3.cus_id
   and p1.guar_cont_no = p4.guar_cont_no
   and p4.guaranty_id = p5.guar_id
   and p1.guar_cont_state = '01'
   and p3.cont_no = ${_SIG_VALUE}
  ]]>
   </SELECT>
</SQL>

<SQL id="queryIqpPoolManaInfoList" parameterClass="com.ecc.emp.data.KeyedCollection" resultClass="com.ecc.emp.data.KeyedCollection" >
   <SELECT>
  <![CDATA[
   select guar_cont_no,
       guar_cont_cn_no,
       guar_start_date,
       guar_end_date,
       amt from(select p2.guar_cont_no,
                   p2.guar_cont_cn_no,
                   p2.guar_start_date,
                   p2.guar_end_date,
                   nvl(p1.crd_rgtchg_amt, 0) amt
              from iqp_actrecpo_mana p1,
                   grt_guar_cont     p2,
                   grt_guaranty_re   p3
             where p1.po_no = p3.guaranty_id
               and p2.guar_cont_no = p3.guar_cont_no
               and p1.status = '2'
               and p2.guar_cont_state = '01'
               and p1.po_no = ${po_no}
            union all
            select p2.guar_cont_no,
                   p2.guar_cont_cn_no,
                   p2.guar_start_date,
                   p2.guar_end_date,
                   nvl(p1.bill_amt, 0) amt
              from iqp_drfpo_mana p1, grt_guar_cont p2, grt_guaranty_re p3
             where p1.drfpo_no = p3.guaranty_id
               and p2.guar_cont_no = p3.guar_cont_no
               and p1.status = '01'
               and p2.guar_cont_state = '01'
               and p1.drfpo_no = ${po_no})
  ]]>
   </SELECT>
</SQL>
<!--add by lisj 2015-7-22  需求编号：【XD150710050】信贷业务纸质档案封面的导出与打印功能变更  end-->

<!-- modify by wangj 2015-05-28  需求编号:XD141222087,法人账户透支需求变更  begin   -->
<!-- 获取是否存在审批中的合同法人账户透支申请  modify by wangj 2015-05-28  需求编号:XD141222087,法人账户透支需求变更     -->
<SQL id="queryApplingIqpLoanAppBySerno" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" onlyReturnFirst="false" >
   <SELECT>
  <![CDATA[
	SELECT t0.serno FROM Iqp_Loan_App t0 WHERE t0.approve_status='111' and  t0.serno in 
 (SELECT t.serno FROM r_bus_lmt_info t WHERE t.agr_no=(SELECT t1.org_limit_code FROM Lmt_App_Details t1 WHERE t1.serno=${_SIG_VALUE} and t1.limit_name='100051'))
  ]]>
   </SELECT>
</SQL>
<!-- 获取额度关联的合同信息  modify by wangj 2015-05-28  需求编号:XD141222087,法人账户透支需求变更    需求编号:XD150825064_源泉宝法人账户透支改造 -->
<SQL id="queryCtrLoanCountByLimtCodeSerno" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" onlyReturnFirst="false" >
   <SELECT>
  <![CDATA[
	SELECT t0.cus_id,t0.cont_no,t0.cont_status FROM ctr_loan_cont t0 WHERE t0.cont_status in ('100','200') and t0.prd_id='100051' and t0.cont_no in 
 (SELECT t.cont_no FROM r_bus_lmt_info t WHERE t.agr_no=(SELECT t1.org_limit_code FROM Lmt_App_Details t1 WHERE t1.serno=${_SIG_VALUE} and t1.limit_name='100051'  and (t1.FROZE_AMT>0 or t1.UNFROZE_AMT>0 ) ))
  ]]>
   </SELECT>
</SQL>
<!-- 获取小微自助额度关联的合同信息  add by lisj 2015-6-1 需求编号：【XD150123005】小微自助循环贷款改造  -->
<SQL id="queryRelCLCBySerno" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" onlyReturnFirst="false" >
   <SELECT>
  <![CDATA[
	SELECT T0.CUS_ID,T0.CONT_NO,T0.CONT_STATUS FROM CTR_LOAN_CONT T0 WHERE T0.CONT_STATUS IN ('100','200')  AND T0.PRD_ID='100088' AND  T0.CONT_NO IN 
 (SELECT T.CONT_NO FROM R_BUS_LMT_INFO T WHERE T.AGR_NO=(SELECT T1.ORG_LIMIT_CODE FROM LMT_APP_DETAILS T1 WHERE T1.SERNO=${_SIG_VALUE} AND T1.LIMIT_NAME='100088'  and (t1.FROZE_AMT>0 or t1.UNFROZE_AMT>0 ) ))
  ]]>
   </SELECT>
</SQL>
<!-- 检查小微自助循环贷款额度是否存在关联的在途业务申请信息  add by lisj 2015-6-1 需求编号：【XD150123005】小微自助循环贷款改造  -->
<SQL id="checkApprovingLoanTranByLmtSerno" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" onlyReturnFirst="false">
   <SELECT>
  <![CDATA[
		SELECT P1.SERNO
  			FROM IQP_LOAN_APP P1
 				WHERE P1.APPROVE_STATUS = '111'
   				AND P1.SERNO IN
       (SELECT T.SERNO FROM R_BUS_LMT_INFO T
         WHERE T.AGR_NO IN (SELECT T1.ORG_LIMIT_CODE
                             FROM LMT_APP_DETAILS T1
                            WHERE T1.SERNO = ${_SIG_VALUE}
                              AND T1.LIMIT_NAME = '100088'))
    UNION ALL
	SELECT P2.SERNO
        FROM PVP_LOAN_APP P2
         WHERE P2.APPROVE_STATUS = '111'
           AND P2.CONT_NO IN
       (SELECT T.CONT_NO FROM R_BUS_LMT_INFO T
         WHERE T.AGR_NO IN (SELECT T1.ORG_LIMIT_CODE
                             FROM LMT_APP_DETAILS T1
                            WHERE T1.SERNO = ${_SIG_VALUE}
                              AND T1.LIMIT_NAME = '100088'))
  ]]>
   </SELECT>
</SQL>

<!-- modify by wangj 2015-05-28  需求编号:XD141222087,法人账户透支需求变更  end   -->
<!-- 检查额度授信分项为抵押或质押是否存在相应的担保合同及担保物  add by wangj 2015-6-11 需求编号：XD150407025_2015 分支机构授权配置/modified by yangzy 2015/06/12 过滤出库核销  -->
<SQL id="checkExistGuaranty" parameterClass="com.ecc.emp.data.KeyedCollection" resultClass="com.ecc.emp.data.KeyedCollection" onlyReturnFirst="false">
   <SELECT>
  <![CDATA[
		select count(*) as cnt from grt_guaranty_re p1 where exists (select 1
          from mort_guaranty_base_info p2
         where p1.guaranty_id = p2.guaranty_no and p2.guaranty_cls = ${guaranty_cls} and p2.guaranty_info_status <> '4') and p1.guar_cont_no =${guar_cont_no}
  ]]>
   </SELECT>
</SQL>
<!-- 获取集团流程相关成员及集团的主管客户经理和管理机构  added by yangzy 2015/04/23 集团流程改造，当成员发起流程时，流程需要经过集团主办行行长审批 
<SQL id="queryLmtAppGrpManagerInfoBySerno" parameterClass="java.lang.String" resultClass="com.ecc.emp.data.KeyedCollection" >
    <SELECT>
      <![CDATA[
			select *
			  from (select t.manager_id, t.manager_br_id, '1' pkid
			          from lmt_app_grp t
			         where serno = ${_SIG_VALUE}
			        union
			        select t.manager_id, t.manager_br_id, '2' pkid
			          from lmt_apply t
			         where t.manager_br_id not in
               			   (select t.manager_br_id
                  			  from lmt_app_grp t
                 			 where serno = ${_SIG_VALUE})
			           and grp_serno = ${_SIG_VALUE}) p1
			 where p1.manager_br_id not in
			       (select orgid
			          from (select row_number() over(partition by t.orgid order by t.commenttime desc) rn,
			                       t.commentsign,
			                       t.orgid,
			                       t.commenttime
			                  from wf_comment t
			                 where t.nodeid = '5_a9'
			                   and t.commenttime >
			                       (select max(t.commenttime)
			                          from wf_comment t
			                         where t.nodeid = '5_a8'
			                           and commentsign = '10'
			                           and t.instanceid in
			                               (select instanceid
			                                  from wfi_join t
			                                 where t.pk_value = ${_SIG_VALUE}))
			                   and t.instanceid in
			                       (select instanceid
			                          from wfi_join t
			                         where t.pk_value = ${_SIG_VALUE}))
			         where rn = 1
			           and commentsign = '10')
			 order by pkid desc, manager_br_id desc
      ]]>
    </SELECT>
</SQL>-->

</S>